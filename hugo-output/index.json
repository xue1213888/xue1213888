[{"categories":["typescript"],"content":" æœ¬ç¯‡ç¬”è®°æ˜¯é˜…è¯»é˜®ä¸€å³°è€å¸ˆçš„ã€ŠTypeScript æ•™ç¨‹ã€‹æ€»ç»“å‡ºæ¥çš„ç¬”è®° ç¬”è®°æ­£åœ¨æ›´æ–°ä¸­ï¼Œé¢„è®¡26å¤©å®Œæˆï¼Œä¸€å¤©ä¸€ç¯‡ã€‚ 1. åŸºæœ¬ç”¨æ³• 2024å¹´04æœˆ18æ—¥å‡Œæ™¨ä¸‰ç‚¹æ€»ç»“ ","date":"2024-04-18","objectID":"/typescript%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/:0:0","tags":["typescript"],"title":"typescriptå­¦ä¹ ç¬”è®°ï¼Œä¸€ç¯‡åŒ…å«æ‰€æœ‰çŸ¥è¯†ç‚¹çš„ç¬”è®°","uri":"/typescript%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"},{"categories":["typescript"],"content":"1. ç±»å‹å£°æ˜ å£°æ˜æ–¹å¼ï¼šå†’å·+ç±»å‹ let foo:string; let foo:string = 'hello world!'; function toString(num: number):string { return String(num); } ","date":"2024-04-18","objectID":"/typescript%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/:1:0","tags":["typescript"],"title":"typescriptå­¦ä¹ ç¬”è®°ï¼Œä¸€ç¯‡åŒ…å«æ‰€æœ‰çŸ¥è¯†ç‚¹çš„ç¬”è®°","uri":"/typescript%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"},{"categories":["typescript"],"content":"2. ç±»å‹æ¨æ–­ ç±»å‹å£°æ˜ä¸æ˜¯å¿…è¦çš„ï¼Œå¦‚æœæ²¡æœ‰ï¼ŒTypeScriptä¼šè‡ªå·±æ¨æ–­ã€‚ let foo = 123; // æ¨æ–­ä¸º number function toString(num: number) { // è¿”å›å€¼æ¨æ–­ä¸º string return String(num) } ","date":"2024-04-18","objectID":"/typescript%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/:2:0","tags":["typescript"],"title":"typescriptå­¦ä¹ ç¬”è®°ï¼Œä¸€ç¯‡åŒ…å«æ‰€æœ‰çŸ¥è¯†ç‚¹çš„ç¬”è®°","uri":"/typescript%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"},{"categories":["typescript"],"content":"3. TypeScriptçš„ç¼–è¯‘ æµè§ˆå™¨å’Œ Node.js ä¸è®¤è¯† TypeScript ã€‚æ‰€ä»¥æå‰éœ€è¦æŠŠ TypeScript ç¼–è¯‘ä¸º JavaScriptã€‚è¿™ä¸ªè¿‡ç¨‹å«åšç¼–è¯‘ã€‚æ‰€ä»¥ TypeScript æ˜¯ç¼–è¯‘æ—¶ç±»å‹æ£€æŸ¥ï¼Œç¼–è¯‘åå°±ä¸ä¼šæ£€æŸ¥äº†ã€‚ ","date":"2024-04-18","objectID":"/typescript%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/:3:0","tags":["typescript"],"title":"typescriptå­¦ä¹ ç¬”è®°ï¼Œä¸€ç¯‡åŒ…å«æ‰€æœ‰çŸ¥è¯†ç‚¹çš„ç¬”è®°","uri":"/typescript%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"},{"categories":["typescript"],"content":"4. å€¼ä¸ç±»å‹ æ³¨æ„è¦åˆ†æ¸…æ¥š å€¼ å’Œ ç±»å‹ ã€‚ TypeScript ä»£ç åªæ¶‰åŠç±»å‹ï¼Œä¸æ¶‰åŠå€¼ï¼Œæ‰€æœ‰å’Œå€¼æœ‰å…³çš„å…¶å®éƒ½æ˜¯ JavaScript å®Œæˆçš„ã€‚ ç¼–è¯‘æ—¶ï¼Œç³»ç»Ÿä¹Ÿä»…ä»…æ˜¯å°† TypeScript ä¹Ÿå°±æ˜¯ ç±»å‹ å…¨éƒ¨æ‹¿æ‰ã€‚ ","date":"2024-04-18","objectID":"/typescript%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/:4:0","tags":["typescript"],"title":"typescriptå­¦ä¹ ç¬”è®°ï¼Œä¸€ç¯‡åŒ…å«æ‰€æœ‰çŸ¥è¯†ç‚¹çš„ç¬”è®°","uri":"/typescript%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"},{"categories":["typescript"],"content":"5. Playground Â TypeScript Playground ","date":"2024-04-18","objectID":"/typescript%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/:5:0","tags":["typescript"],"title":"typescriptå­¦ä¹ ç¬”è®°ï¼Œä¸€ç¯‡åŒ…å«æ‰€æœ‰çŸ¥è¯†ç‚¹çš„ç¬”è®°","uri":"/typescript%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"},{"categories":["typescript"],"content":"6. tsc ç¼–è¯‘å™¨ å°† .ts æ–‡ä»¶ç¼–è¯‘ä¸º .js çš„å·¥å…·ã€‚ ","date":"2024-04-18","objectID":"/typescript%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/:6:0","tags":["typescript"],"title":"typescriptå­¦ä¹ ç¬”è®°ï¼Œä¸€ç¯‡åŒ…å«æ‰€æœ‰çŸ¥è¯†ç‚¹çš„ç¬”è®°","uri":"/typescript%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"},{"categories":["typescript"],"content":"6.1 å®‰è£… ## ä¸‹é¢å‘½ä»¤æ˜¯å…¨å±€å®‰è£…ï¼Œä½ ä¹Ÿå¯ä»¥ä»…åœ¨é¡¹ç›®ä¸­è¿›è¡Œå®‰è£… tsc ä¾èµ–æ¨¡å— npm install -g typescript ## è·å–å½“å‰ tsc ç‰ˆæœ¬ tsc -v ## è·å–å¸®åŠ©ä¿¡æ¯ tsc -h ## æŸ¥çœ‹å®Œæ•´å¸®åŠ©ä¿¡æ¯ tsc --all ","date":"2024-04-18","objectID":"/typescript%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/:6:1","tags":["typescript"],"title":"typescriptå­¦ä¹ ç¬”è®°ï¼Œä¸€ç¯‡åŒ…å«æ‰€æœ‰çŸ¥è¯†ç‚¹çš„ç¬”è®°","uri":"/typescript%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"},{"categories":["typescript"],"content":"6.2 ç¼–è¯‘ tsc app.ts ## åŒæ—¶ç¼–è¯‘å¤šä¸ªæ–‡ä»¶ tsc file1.ts file2.ts file3.ts ## outFile å¤šä¸ªæ–‡ä»¶ç¼–è¯‘è¾“å‡ºåˆ°ä¸€ä¸ªæ–‡ä»¶ tsc file1.ts file2.ts file3.ts --outFile app.js ## outDir æŒ‡å®šç¼–è¯‘åˆ°æŒ‡å®šç›®å½• tsc app.ts --outDir dist ## target é»˜è®¤ä¼šç¼–è¯‘ä¸º es3 ç‰ˆæœ¬ï¼Œæ¨èæŒ‡å®š es2015 tsc --target es2015 app.ts ","date":"2024-04-18","objectID":"/typescript%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/:6:2","tags":["typescript"],"title":"typescriptå­¦ä¹ ç¬”è®°ï¼Œä¸€ç¯‡åŒ…å«æ‰€æœ‰çŸ¥è¯†ç‚¹çš„ç¬”è®°","uri":"/typescript%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"},{"categories":["typescript"],"content":"6.3 ç¼–è¯‘é”™è¯¯å¤„ç† å¦‚æœæ²¡æœ‰é”™è¯¯ï¼Œtsc å‘½ä»¤ä¸ä¼šæœ‰ä»»ä½•æ˜¾ç¤ºã€‚ ç¼–è¯‘å‡ºç°é”™è¯¯ä¼šæŠ¥é”™ï¼ŒåŒæ—¶ä¹Ÿä¼šç”Ÿæˆç›¸åº”çš„ js æ–‡ä»¶ï¼Œå¼€å‘è€…åº”è¯¥è‡ªå·±è€ƒè™‘æ˜¯ä¸æ˜¯ç¬¦åˆé¢„æœŸã€‚ å¦‚æœä½ æƒ³åœ¨æŠ¥é”™æ—¶åœæ­¢ç¼–è¯‘ï¼Œè¯·ä½¿ç”¨noEmitOnErrorå‚æ•° tsc --noEmitOnError app.ts è¿˜æœ‰ä¸€ä¸ªåªæ£€æŸ¥æ˜¯å¦æ­£ç¡®ï¼Œæ— è®ºæ­£ç¡®ä¸å¦éƒ½ä¸è¿›è¡Œç¼–è¯‘ noEmitã€‚ tsc --noEmit app.ts ","date":"2024-04-18","objectID":"/typescript%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/:6:3","tags":["typescript"],"title":"typescriptå­¦ä¹ ç¬”è®°ï¼Œä¸€ç¯‡åŒ…å«æ‰€æœ‰çŸ¥è¯†ç‚¹çš„ç¬”è®°","uri":"/typescript%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"},{"categories":["typescript"],"content":"6.4 tsconfig.json è¯¥æ–‡ä»¶å¯ä»¥å°† tsc å‘½ä»¤å†™åˆ° json æ–‡ä»¶ä¸­ï¼Œè¿™æ ·å°±ä¸ç”¨æ¯æ¬¡å†™ tsc å‘½ä»¤æ—¶å†™ä¸€é•¿ä¸²ã€‚ ä¾‹å¦‚ï¼š æ–¹æ³•1 tsc file1.ts file2.ts --outFile dist/app.js æ–¹æ³•2Â  { \"files\": [\"file1.ts\", \"file2.ts\"], \"compilerOptions\": { \"outFile\": \"dist/app.js\" } } tsc ","date":"2024-04-18","objectID":"/typescript%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/:6:4","tags":["typescript"],"title":"typescriptå­¦ä¹ ç¬”è®°ï¼Œä¸€ç¯‡åŒ…å«æ‰€æœ‰çŸ¥è¯†ç‚¹çš„ç¬”è®°","uri":"/typescript%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"},{"categories":["typescript"],"content":"7. ts-node æ¨¡å— node ç¯å¢ƒä¸æ”¯æŒç›´æ¥è¿è¡Œ ts æ–‡ä»¶ï¼Œå¯ä»¥ä½¿ç”¨ ts-node ã€‚ npm install -g ts-node ts-node script.ts å¦‚æœä¸å®‰è£… ts-node ä¹Ÿå¯ä»¥ä½¿ç”¨ npx æ¥è°ƒç”¨ npx ts-node script.ts ä¹Ÿå¯ä»¥åƒ node ä¸€æ ·ï¼Œèµ·ä¸€ä¸ªäº¤äº’çª—å£è¿›è¡Œäº’åŠ¨ã€‚ $ ts-node \u003e const twice = (x:string) =\u003e x + x; \u003e twice('abc') 'abcabc' \u003e é€€å‡ºä½¿ç”¨ Ctrl + dã€‚æˆ–è€…è¾“å…¥ .exit ã€‚ 2. anyç±»å‹ï¼Œunknownç±»å‹ï¼Œneverç±»å‹ 2024å¹´4æœˆ18æ—¥å‡Œæ™¨3ç‚¹æ€»ç»“ï¼Œæœªå®Œæˆ ","date":"2024-04-18","objectID":"/typescript%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/:7:0","tags":["typescript"],"title":"typescriptå­¦ä¹ ç¬”è®°ï¼Œä¸€ç¯‡åŒ…å«æ‰€æœ‰çŸ¥è¯†ç‚¹çš„ç¬”è®°","uri":"/typescript%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"},{"categories":["typescript"],"content":"1. anyç±»å‹ ","date":"2024-04-18","objectID":"/typescript%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/:8:0","tags":["typescript"],"title":"typescriptå­¦ä¹ ç¬”è®°ï¼Œä¸€ç¯‡åŒ…å«æ‰€æœ‰çŸ¥è¯†ç‚¹çš„ç¬”è®°","uri":"/typescript%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"},{"categories":["typescript"],"content":"1.1 åŸºæœ¬å«ä¹‰ anyç±»å‹è¡¨ç¤ºæ²¡æœ‰ä»»ä½•é™åˆ¶ã€‚å¦‚æœæŸä¸ªå˜é‡è®¾ç½®ä¸º any ã€‚ TypeScript ä¼šå…³é—­è¯¥å˜é‡çš„ç±»å‹æ£€æŸ¥ã€‚ let x: any; // å½“ x æ˜¯ any çš„æ—¶å€™ï¼Œä¸‹é¢è¯­å¥éƒ½ä¸æŠ¥é”™ x = 1; x = 'foo'; x = true; x(2); x.foo = 100; å°½é‡é¿å…ä½¿ç”¨ any ç±»å‹ã€‚ ","date":"2024-04-18","objectID":"/typescript%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/:8:1","tags":["typescript"],"title":"typescriptå­¦ä¹ ç¬”è®°ï¼Œä¸€ç¯‡åŒ…å«æ‰€æœ‰çŸ¥è¯†ç‚¹çš„ç¬”è®°","uri":"/typescript%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"},{"categories":["typescript"],"content":"1.2 ç±»å‹æ¨æ–­ ","date":"2024-04-18","objectID":"/typescript%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/:8:2","tags":["typescript"],"title":"typescriptå­¦ä¹ ç¬”è®°ï¼Œä¸€ç¯‡åŒ…å«æ‰€æœ‰çŸ¥è¯†ç‚¹çš„ç¬”è®°","uri":"/typescript%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"},{"categories":["go runtime"],"content":"å¯¹ä¸€æ¬¡æ€§äº‹ä»¶è¿›è¡Œç¡çœ å’Œå”¤é†’ã€‚åœ¨è°ƒç”¨ notesleep æˆ–è€… notewakeup ä¹‹å‰ï¼Œå¿…é¡»è°ƒç”¨ noteclear æ¥åˆå§‹åŒ– note ã€‚ç„¶åï¼Œä¸€ä¸ªçº¿ç¨‹å¯ä»¥è°ƒç”¨ notesleep ï¼Œä¸€ä¸ªçº¿ç¨‹å¯ä»¥è°ƒç”¨ notewakeup ä¸€æ¬¡ï¼Œä¸€ç‚¹è°ƒç”¨äº† notewakeup ï¼Œ notesleep å°±ä¼šè¿”å›ã€‚åç»­è°ƒç”¨ notesleep å°†ç«‹å³è¿”å›ã€‚ä¹‹åçš„ noteclear å¿…é¡»åœ¨ä¹‹å‰çš„ notesleep è¿”å›åè°ƒç”¨ã€‚æ¯”å¦‚ï¼Œä¸å…è®¸åœ¨ notewakeup ä¹‹åç›´æ¥è°ƒç”¨ noteclearã€‚ notetsleep å’Œ notesleep ç±»ä¼¼ï¼Œä½†å³ä½¿äº‹ä»¶å°šæœªå‘ç”Ÿï¼Œä¹Ÿä¼šåœ¨ç»™å®šçš„nsåå”¤é†’ã€‚å¦‚æœä¸€ä¸ª goroutine ä½¿ç”¨ notetsleep æå‰å”¤é†’ï¼Œå®ƒå¿…é¡»ç­‰å¾…è°ƒç”¨ noteclear ï¼Œç›´åˆ°å¯ä»¥ç¡®å®šæ²¡æœ‰å…¶ä»– goroutine åœ¨è°ƒç”¨ notewakeupã€‚ notesleep å’Œ notetsleep é€šå¸¸è¢« g0 è°ƒç”¨ã€‚ notetsleepg ä¸ notetsleep ç›¸ä¼¼ï¼Œä½†è¢«ç”¨æˆ· g è°ƒç”¨ã€‚ è¿™æ˜¯ä¸€å®¶åªèƒ½æ‰“åŒ…å¸¦èµ°é¤å…ã€‚ å°æ˜æ¥ä¹°åˆé¥­ï¼Œéœ€è¦é€šè¿‡ noteclear æ‹¿èµ°ä¸€ä¸ªå«å·ç‰Œï¼Œé€šè¿‡ notesleep å‘Šè¯‰è€æ¿é’±ä»˜è¿‡äº†ï¼Œè¿™ä¸ªç‰Œå­çš„å·ç ç»‘å®šçš„å°±æ˜¯æˆ‘çš„åˆé¤ã€‚è€æ¿æŠŠé¥­åšå¥½äº†è¦å«å· notewakeup ï¼Œæˆ‘ä»¬å¬åˆ°å«å·ï¼Œå°±å»æ‹¿é¤ï¼Œé˜»å¡å°±ç»“æŸäº†ã€‚è€æ¿åªä¼šå«ä¸€æ¬¡å·ï¼Œå¯èƒ½æˆ‘ä»¬æ²¡å¬åˆ°å«å·ï¼Œä½†æ˜¯æˆ‘ä»¬è¿‡å»æŸœå°çœ‹çš„è¯ï¼Œé¤å°±åœ¨é‚£é‡Œæ”¾ç€ï¼Œä¸Šé¢ä¹Ÿå†™ç€æ˜¯å¤šå°‘å·çš„é¤ã€‚ä¹Ÿå°±æ˜¯ notewakeup åï¼Œç»§ç»­è°ƒç”¨ notesleep ä¸ä¼šé˜»å¡ï¼Œç«‹å³è¿”å›ã€‚ ä»Šå¤©æ¯”è¾ƒç€æ€¥ï¼Œæˆ‘åªæ„¿æ„ç­‰10åˆ†é’Ÿï¼Œè¶…æ—¶å°æ˜ä¸Šè¯¾å°±è¿Ÿåˆ°äº†ï¼Œå¥–å­¦é‡‘å°±æ²¡æœ‰äº†ï¼Œæ‰€ä»¥å°æ˜é€šè¿‡ notetsleep å‘Šè¯‰è€æ¿æˆ‘å¾ˆæ€¥ï¼Œåªèƒ½ç­‰10åˆ†é’Ÿï¼Œå°æ˜åœ¨10åˆ†é’Ÿæ‹¿åˆ°é¤å°±æ˜¯æ­£å¸¸æƒ…å†µï¼Œä½†å¯èƒ½è€æ¿æ²¡åšå‡ºæ¥ï¼Œå°æ˜å°±ä¸ç­‰äº†ï¼Œè€æ¿åšå‡ºæ¥ä¹‹åï¼Œçœ‹äº†çœ‹å·ç ç‰Œï¼Œå¥½åƒæ²¡äººè¦è¿™ä¸ªé¤äº†ã€‚å°æ˜è¯¾ä¸Šå®Œå¦‚æœæƒ³èµ·æ¥è‡ªå·±è¿˜æœ‰ä¸ªé¤æ²¡æ‹¿ï¼Œè¿‡æ¥ä¹Ÿæ˜¯èƒ½ç›´æ¥æ‹¿åˆ°çš„ã€‚ ","date":"2022-09-07","objectID":"/5.-runtime%E4%B9%8Bnote%E4%B8%80%E6%AC%A1%E6%80%A7%E9%80%9A%E7%9F%A5%E4%BA%8B%E4%BB%B6-copy/:0:0","tags":["runtime","goåº•å±‚å®ç°"],"title":"5. runtimeä¹‹noteä¸€æ¬¡æ€§é€šçŸ¥äº‹ä»¶","uri":"/5.-runtime%E4%B9%8Bnote%E4%B8%80%E6%AC%A1%E6%80%A7%E9%80%9A%E7%9F%A5%E4%BA%8B%E4%BB%B6-copy/"},{"categories":["go runtime"],"content":"ç»“æ„ åŸºäºfutexå®ç°ï¼Œkeyæ˜¯ä¸€ä¸ªuint32çš„å€¼ åŸºäºsemaå®ç°ï¼Œkeyæ˜¯ä¸€ä¸ªwaitm type note struct { key uintptr } ","date":"2022-09-07","objectID":"/5.-runtime%E4%B9%8Bnote%E4%B8%80%E6%AC%A1%E6%80%A7%E9%80%9A%E7%9F%A5%E4%BA%8B%E4%BB%B6-copy/:1:0","tags":["runtime","goåº•å±‚å®ç°"],"title":"5. runtimeä¹‹noteä¸€æ¬¡æ€§é€šçŸ¥äº‹ä»¶","uri":"/5.-runtime%E4%B9%8Bnote%E4%B8%80%E6%AC%A1%E6%80%A7%E9%80%9A%E7%9F%A5%E4%BA%8B%E4%BB%B6-copy/"},{"categories":["go runtime"],"content":"åŸºäºsemaå®ç° ","date":"2022-09-07","objectID":"/5.-runtime%E4%B9%8Bnote%E4%B8%80%E6%AC%A1%E6%80%A7%E9%80%9A%E7%9F%A5%E4%BA%8B%E4%BB%B6-copy/:2:0","tags":["runtime","goåº•å±‚å®ç°"],"title":"5. runtimeä¹‹noteä¸€æ¬¡æ€§é€šçŸ¥äº‹ä»¶","uri":"/5.-runtime%E4%B9%8Bnote%E4%B8%80%E6%AC%A1%E6%80%A7%E9%80%9A%E7%9F%A5%E4%BA%8B%E4%BB%B6-copy/"},{"categories":["go runtime"],"content":"åˆå§‹åŒ–ä¸€æ¬¡æ€§é€šçŸ¥æˆ–è€…æ¸…é›¶ä¸€æ¬¡æ€§é€šçŸ¥ // å°±æ˜¯ç»™keyè®¾ç½®æˆäº†0 func noteclear(n *note) { if GOOS == \"aix\" { atomic.Storeuintptr(\u0026n.key, 0) } else { n.key = 0 } } ","date":"2022-09-07","objectID":"/5.-runtime%E4%B9%8Bnote%E4%B8%80%E6%AC%A1%E6%80%A7%E9%80%9A%E7%9F%A5%E4%BA%8B%E4%BB%B6-copy/:2:1","tags":["runtime","goåº•å±‚å®ç°"],"title":"5. runtimeä¹‹noteä¸€æ¬¡æ€§é€šçŸ¥äº‹ä»¶","uri":"/5.-runtime%E4%B9%8Bnote%E4%B8%80%E6%AC%A1%E6%80%A7%E9%80%9A%E7%9F%A5%E4%BA%8B%E4%BB%B6-copy/"},{"categories":["go runtime"],"content":"é˜»å¡ç­‰å¾…é€šçŸ¥ func notesleep(n *note) { // å¾—åˆ°g gp := getg() // å¦‚æœ g ä¸æ˜¯ g0ï¼Œæˆ‘ä»¬æŠ›å‡ºé”™è¯¯ if gp != gp.m.g0 { throw(\"notesleep not on g0\") } // åˆå§‹åŒ–ä¿¡å· semacreate(gp.m) // å¦‚æœ key æ˜¯ 0 ï¼Œè¯æ˜è¿™æ˜¯ä¸€ä¸ªæ–°åˆå§‹åŒ–çš„ note // æˆ‘ä»¬è®©ä»–å­˜å‚¨å½“å‰ m çš„åœ°å€ if !atomic.Casuintptr(\u0026n.key, 0, uintptr(unsafe.Pointer(gp.m))) { // å¦‚æœå­˜å‚¨å¤±è´¥ï¼Œè¯æ˜ n.key ä¸æ˜¯ 0ã€‚ // å¦‚æœæˆ‘ä»¬çš„å·²ç»è°ƒç”¨äº† notewakeup ï¼Œ å¯¼è‡´ n.key æ˜¯ lockedï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±è¿”å› // å¦‚æœ n.key ä¸æ˜¯ locked ä¹Ÿä¸æ˜¯é”å®šçŠ¶æ€ï¼Œæˆ‘ä»¬è¿™è¾¹è¿˜è¦é˜»å¡çš„è¯ï¼Œå°±æŠ¥é”™ã€‚ if n.key != locked { throw(\"notesleep - waitm out of sync\") } return } // n.key å­˜å‚¨äº† m çš„åœ°å€ï¼ŒæˆåŠŸäº†ï¼Œæˆ‘ä»¬è¦è®©ä»–ç­‰å¾… gp.m.blocked = true if *cgo_yield == nil { // æ— é™ç­‰å¾…é€šçŸ¥ semasleep(-1) } else { // ä¼‘çœ ä¸€ä¸ªä»»æ„ä½†é€‚ä¸­çš„é—´éš”æ¥è½®è¯¢ libc æ‹¦æˆªå™¨ã€‚ const ns = 10e6 // å¦‚æœè¿™ä¸ªæ—¶å€™ n.key æ˜¯ 0 çš„è¯ï¼Œè¯æ˜è¢« wakeup äº† for atomic.Loaduintptr(\u0026n.key) == 0 { semasleep(ns) asmcgocall(*cgo_yield, nil) } } gp.m.blocked = false } æµç¨‹å¦‚ä¸‹ ç°åœ¨ g0 è¦é˜»å¡ç›´åˆ°å¾—åˆ°ä¸€ä¸ªé€šçŸ¥ã€‚ æ£€æŸ¥ note.key != 0 ï¼Œè¯æ˜è¿™ä¸ª note å·²ç»è¢« wakeup(==locked) æˆ–è€… å½“å‰æ­£åœ¨ sleep(==waitm) ä¸­ã€‚ ç»§ç»­åˆ¤æ–­å¦‚æœ note.key != locked ï¼Œä¹Ÿå°±æ˜¯å·²ç» sleep ï¼Œæˆ‘ä»¬å°±æŠ¥é”™ï¼Œå› ä¸ºå·²ç»è¿™ä¸ª note ä¸Šé¢æ­£åœ¨ç¡çœ ç­‰å¾…ï¼Œå¦‚æœ note.key == locked è¯æ˜å·²ç»è¢«å”¤é†’ï¼Œæˆ‘ä»¬å°±ç›´æ¥è¿”å›ï¼Œå› ä¸ºæˆ‘ä»¬åªä¼šå”¤é†’ä¸€æ¬¡ï¼Œåç»­è°ƒç”¨ sleep å°†ä¸ä¼šè¿›è¡Œé˜»å¡ å¦‚æœ note.key == 0 ï¼Œæˆ‘ä»¬å°±å°† m çš„åœ°å€å­˜å…¥ note.key ä¸­ã€‚å¼€å¯ä¿¡å·é‡ç­‰å¾…å°±å¥½äº† ","date":"2022-09-07","objectID":"/5.-runtime%E4%B9%8Bnote%E4%B8%80%E6%AC%A1%E6%80%A7%E9%80%9A%E7%9F%A5%E4%BA%8B%E4%BB%B6-copy/:2:2","tags":["runtime","goåº•å±‚å®ç°"],"title":"5. runtimeä¹‹noteä¸€æ¬¡æ€§é€šçŸ¥äº‹ä»¶","uri":"/5.-runtime%E4%B9%8Bnote%E4%B8%80%E6%AC%A1%E6%80%A7%E9%80%9A%E7%9F%A5%E4%BA%8B%E4%BB%B6-copy/"},{"categories":["go runtime"],"content":"å”¤é†’é€šçŸ¥ func notewakeup(n *note) { var v uintptr for { // v æ˜¯æˆ‘ä»¬ n.key çš„å€¼ v = atomic.Loaduintptr(\u0026n.key) // å¦‚æœ v æ²¡æœ‰è¢«å…¶ä»–çº¿ç¨‹ä¿®æ”¹ï¼Œæˆ‘ä»¬å°±è®©å®ƒçš„çŠ¶æ€ä¸ºlocked if atomic.Casuintptr(\u0026n.key, v, locked) { break } } // è¿™é‡Œçš„ v è¿˜æ˜¯ä¹‹å‰ key çš„å€¼ switch { case v == 0: // å¦‚æœä¹‹å‰ v == 0 è¯æ˜ä¹‹å‰å°±æ˜¯ä¸€ä¸ªè§£é”çš„çŠ¶æ€ï¼Œå¹¶ä¸”æ²¡æœ‰å­˜å‚¨waitmï¼Œæˆ‘ä»¬ç›´æ¥ç»“æŸå°±å¥½äº†ï¼ŒåŠ é”å·²ç»å®Œæˆ case v == locked: // å¦‚æœä¹‹å‰å°±æ˜¯é”å®šçš„ï¼Œæˆ‘ä»¬å°±æŠ¥é”™ throw(\"notewakeup - double wakeup\") default: // v é‡Œé¢å­˜å‚¨çš„æ˜¯ä¸€ä¸ª waitm semawakeup((*m)(unsafe.Pointer(v))) } } ","date":"2022-09-07","objectID":"/5.-runtime%E4%B9%8Bnote%E4%B8%80%E6%AC%A1%E6%80%A7%E9%80%9A%E7%9F%A5%E4%BA%8B%E4%BB%B6-copy/:2:3","tags":["runtime","goåº•å±‚å®ç°"],"title":"5. runtimeä¹‹noteä¸€æ¬¡æ€§é€šçŸ¥äº‹ä»¶","uri":"/5.-runtime%E4%B9%8Bnote%E4%B8%80%E6%AC%A1%E6%80%A7%E9%80%9A%E7%9F%A5%E4%BA%8B%E4%BB%B6-copy/"},{"categories":["go runtime"],"content":"å¸¦æœ€å¤§å”¤é†’ç­‰å¾…æ—¶é—´çš„ç­‰å¾… func notetsleep(n *note, ns int64) bool { gp := getg() if gp != gp.m.g0 { throw(\"notetsleep not on g0\") } semacreate(gp.m) return notetsleep_internal(n, ns, nil, 0) } func notetsleep_internal(n *note, ns int64, gp *g, deadline int64) bool { // gp å’Œ deadline æŒ‰é€»è¾‘æ¥è¯´æ˜¯å±€éƒ¨å˜é‡ï¼Œä½†æ˜¯ä¸ºäº†å­˜åœ¨è°ƒç”¨è€…çš„æ ˆä¸­ï¼Œæˆ‘ä»¬å†™æˆäº†å‚æ•° // è¿™å‡å°‘äº† notetsleep_internal çš„ nosplit å ç”¨ç©ºé—´ã€‚ // æ‹¿åˆ° g ï¼Œ è¿™ä¸ª g æ˜¯ g0 gp = getg() // å¦‚æœ n.key != 0 if !atomic.Casuintptr(\u0026n.key, 0, uintptr(unsafe.Pointer(gp.m))) { if n.key != locked { // å¯¹å·²ç»é˜»å¡çš„ note ï¼Œç»§ç»­é˜»å¡ throw(\"notetsleep - waitm out of sync\") } // å·²ç»è¢«å”¤é†’çš„note return true } // å¦‚æœ n.key == 0ï¼Œn.key = uintptr(unsafe.Pointer(gp.m)) // å½“å‰ key æ˜¯è¦é˜»å¡ m çš„åœ°å€ if ns \u003c 0 { // å°äº0ï¼Œå°±æ˜¯æ— é™ç­‰å¾…ï¼Œè·Ÿä¸Šé¢é€»è¾‘ä¸€æ · gp.m.blocked = true if *cgo_yield == nil { semasleep(-1) } else { // Sleep in arbitrary-but-moderate intervals to poll libc interceptors. const ns = 10e6 for semasleep(ns) \u003c 0 { asmcgocall(*cgo_yield, nil) } } gp.m.blocked = false return true } // å½“ ns \u003e= 0ï¼Œè¯æ˜è¦æœ‰ä¸€ä¸ªè¶…æ—¶å”¤é†’æ—¶é—´ deadline = nanotime() + ns for { gp.m.blocked = true if *cgo_yield != nil \u0026\u0026 ns \u003e 10e6 { ns = 10e6 } // semasleep(ns) \u003e= 0 ä»£è¡¨ç€åœ¨è§„å®šæ—¶é—´å†…æ­£å¸¸è¢«å”¤é†’ï¼Œæˆ‘ä»¬è¿”å›true if semasleep(ns) \u003e= 0 { gp.m.blocked = false // Acquired semaphore, semawakeup unregistered us. // Done. return true } // å°å°ä¼‘æ¯ä¸€ä¸‹ï¼Œé˜²æ­¢ç©ºè€—cpu if *cgo_yield != nil { asmcgocall(*cgo_yield, nil) } gp.m.blocked = false // Interrupted or timed out. Still registered. Semaphore not acquired. ns = deadline - nanotime() // ç­‰å¾…è¶…æ—¶äº† if ns \u003c= 0 { break } // Deadline hasn't arrived. Keep sleeping. } // æˆ‘ä»¬è¶…æ—¶æ‹¿ä¸åˆ°ä¿¡å·é‡é€šçŸ¥ï¼Œè¦æ”¾å¼ƒäº† for { // v å°±æ˜¯ waitm v := atomic.Loaduintptr(\u0026n.key) switch v { case uintptr(unsafe.Pointer(gp.m)): // å–æ¶ˆæ³¨å†Œï¼Œè¿”å›ï¼Œæ¸…ç©ºè¿™ä¸ªkeyï¼Œå¦‚æœåˆ«äººå†æ¥å”¤é†’ï¼Œä¹Ÿæ ¹æœ¬å•¥äº‹ä¸åšäº† if atomic.Casuintptr(\u0026n.key, v, 0) { return false } case locked: // å…¶ä»–çº¿ç¨‹æŠŠnoteå”¤é†’ gp.m.blocked = true if semasleep(-1) \u003c 0 { // æ— é™ç­‰å¾…ï¼Œå¦‚æœä¸­æ–­ï¼ŒæŠ›å‡ºå¼‚å¸¸ throw(\"runtime: unable to acquire - semaphore out of sync\") } gp.m.blocked = false // å”¤é†’äº† return true default: // æ„å¤–çš„æƒ…å†µ throw(\"runtime: unexpected waitm - semaphore out of sync\") } } } ","date":"2022-09-07","objectID":"/5.-runtime%E4%B9%8Bnote%E4%B8%80%E6%AC%A1%E6%80%A7%E9%80%9A%E7%9F%A5%E4%BA%8B%E4%BB%B6-copy/:2:4","tags":["runtime","goåº•å±‚å®ç°"],"title":"5. runtimeä¹‹noteä¸€æ¬¡æ€§é€šçŸ¥äº‹ä»¶","uri":"/5.-runtime%E4%B9%8Bnote%E4%B8%80%E6%AC%A1%E6%80%A7%E9%80%9A%E7%9F%A5%E4%BA%8B%E4%BB%B6-copy/"},{"categories":["go runtime"],"content":"ç”¨æˆ· g è°ƒç”¨çš„ç­‰å¾… func notetsleepg(n *note, ns int64) bool { gp := getg() if gp == gp.m.g0 { throw(\"notetsleepg on g0\") } semacreate(gp.m) entersyscallblock() ok := notetsleep_internal(n, ns, nil, 0) exitsyscall() return ok } ","date":"2022-09-07","objectID":"/5.-runtime%E4%B9%8Bnote%E4%B8%80%E6%AC%A1%E6%80%A7%E9%80%9A%E7%9F%A5%E4%BA%8B%E4%BB%B6-copy/:2:5","tags":["runtime","goåº•å±‚å®ç°"],"title":"5. runtimeä¹‹noteä¸€æ¬¡æ€§é€šçŸ¥äº‹ä»¶","uri":"/5.-runtime%E4%B9%8Bnote%E4%B8%80%E6%AC%A1%E6%80%A7%E9%80%9A%E7%9F%A5%E4%BA%8B%E4%BB%B6-copy/"},{"categories":["go runtime"],"content":"sync.Mutex å’Œ sync.Cond éƒ½æ˜¯å¯¹äºåç¨‹ g æ¥è¯´çš„ï¼Œè€Œ m.mOS.mutex å’Œ m.mOS.cond æ˜¯å¯¹çº¿ç¨‹ m æ¥è¯´çš„ï¼Œåº•å±‚ç”¨æ³•å¤§æ¦‚ç›¸åŒã€‚ runtime.mutex åœ¨ sema çš„å®ç°æ–¹æ¡ˆä¸‹ï¼ˆä¸åŒç³»ç»Ÿå†³å®šç€å®ç°æ–¹æ¡ˆçš„ä¸åŒï¼‰ï¼Œåº•å±‚ä¾èµ– m.mOS.mutex å’Œ m.mOS.cond æ¥åŠ è§£é”æ“æ§ m ï¼Œè¿™æ—¶å€™ mutex ä¸­çš„ key æ˜¯ waitm ï¼Œä¸€ä¸ªç­‰å¾…çš„ m çš„åœ°å€ã€‚ runtime.mutex åœ¨ futex çš„å®ç°æ–¹æ¡ˆä¸‹ï¼Œkey å­˜å‚¨ç€é”çš„çŠ¶æ€ ","date":"2022-09-04","objectID":"/4.-runtime%E4%B9%8Bmutex%E7%BA%BF%E7%A8%8B%E9%94%81%E7%9A%84%E5%AE%9E%E7%8E%B0/:0:0","tags":["runtime","goåº•å±‚å®ç°"],"title":"4. runtimeä¹‹mutexçº¿ç¨‹é”çš„å®ç°","uri":"/4.-runtime%E4%B9%8Bmutex%E7%BA%BF%E7%A8%8B%E9%94%81%E7%9A%84%E5%AE%9E%E7%8E%B0/"},{"categories":["go runtime"],"content":"mutexåŸºäºä¿¡å·semaçš„å®ç° ","date":"2022-09-04","objectID":"/4.-runtime%E4%B9%8Bmutex%E7%BA%BF%E7%A8%8B%E9%94%81%E7%9A%84%E5%AE%9E%E7%8E%B0/:1:0","tags":["runtime","goåº•å±‚å®ç°"],"title":"4. runtimeä¹‹mutexçº¿ç¨‹é”çš„å®ç°","uri":"/4.-runtime%E4%B9%8Bmutex%E7%BA%BF%E7%A8%8B%E9%94%81%E7%9A%84%E5%AE%9E%E7%8E%B0/"},{"categories":["go runtime"],"content":"ä¿¡å·çš„å®ç° func semacreate(mp *m) ä¸º m åˆ›å»ºä¿¡å·é‡ï¼Œå¦‚æœå®ƒè¿˜æ²¡æœ‰çš„è¯ã€‚ func semasleep(ns int64) int32 æœ€é•¿é˜»å¡nsçº³ç§’æ¥å¾—åˆ°ä¸€ä¸ªä¿¡å·é‡ï¼ŒæˆåŠŸè¿”å›0ï¼Œå¤±è´¥è¿”å›-1 func semawakeup(mp *m) æ¿€æ´»ä¸€ä¸ªä¿¡å·é‡ æˆ‘ä»¬ä½¿ç”¨ semacreate åˆ›å»ºä¿¡å·é‡ä¹‹åï¼Œæˆ‘ä»¬çš„ä¿¡å·é‡æ˜¯ç©ºçš„ï¼Œæˆ‘ä»¬ä½¿ç”¨ semawakeup ä¿¡å·é‡æ‰ä¼šå¾—åˆ°ä¸€ä¸ªä¿¡å·ï¼Œæˆ‘ä»¬ä½¿ç”¨ semasleep æ˜¯ä¸ºäº†å¾—åˆ°ä¸€ä¸ªä¿¡å·é‡ï¼Œè¿™ä¸ªä¿¡å·é‡æ˜¯ semawakeup å‘é€è¿‡æ¥çš„ï¼Œå¦‚æœåœ¨æˆ‘ä»¬è§„å®šçš„æ—¶é—´æ‹¿ä¸åˆ°ä¿¡å·é‡ï¼Œæˆ–è€…ç¨‹åºä¸­æ–­ï¼Œéƒ½ä¼šè¿”å›-1ã€‚ æŒæœ‰ç»“æ„ // initialized æ˜¯å¦è¢«åˆå§‹åŒ– // mutex äº’æ–¥é” // cond æ¡ä»¶é€šçŸ¥ // count å½“å‰å¯ç›´æ¥è·å–çš„ä¿¡å·é‡æ•°é‡ type mOS struct { initialized bool mutex pthreadmutex cond pthreadcond count int } semasleep å’Œ semawakeup æœ¬è´¨éƒ½æ˜¯æ“ä½œ count çš„ semasleep æ˜¯ count - 1ï¼Œå¦‚æœ count == 0ï¼Œå°±è¦ç­‰ä¸€ä¸ª semawakeup ç»™å®ƒåŠ 1 semawakeup æ˜¯ count + 1ï¼Œå¦‚æœ +1 åçš„ count å¤§äº 0ï¼Œ æˆ‘ä»¬å°±è¦å”¤é†’ä¸€ä¸ªæ­£åœ¨sleep semacreate // ç»™m.mOSçš„mutexå’Œcondåšåˆå§‹åŒ–ï¼Œå¦‚æœå·²ç»è¢«åˆå§‹åŒ–äº†å°±ç®—äº† // è¿™é‡Œçš„mutexå°±æ˜¯ä¸€ä¸ªäº’æ–¥ä½“ï¼Œé˜²æ­¢å¤šä¸ªçº¿ç¨‹å¹¶å‘è®¿é—®ä¿®æ”¹æ•°æ®å¯¼è‡´å‡ºé”™çš„ func semacreate(mp *m) { // å¦‚æœå·²ç»è¢«åˆå§‹åŒ–ï¼Œå°±ä¸è¦å†åˆå§‹åŒ–äº† if mp.initialized { return } mp.initialized = true // åˆå§‹åŒ–é”ï¼Œäº’æ–¥ä½“ if err := pthread_mutex_init(\u0026mp.mutex, nil); err != 0 { throw(\"pthread_mutex_init\") } // åˆå§‹åŒ–æ¡ä»¶é€šçŸ¥ if err := pthread_cond_init(\u0026mp.cond, nil); err != 0 { throw(\"pthread_cond_init\") } } semasleep // é˜»å¡æ¥è·å–ä¿¡å· // nså¦‚æœå°äº0ï¼Œå®ƒä¼šä¸€ç›´é˜»å¡ç­‰åˆ°èƒ½å¤Ÿè·å–ä¿¡å·ä¸ºæ­¢ // nså¦‚æœå¤§äºç­‰äº0ï¼Œå®ƒä¼šæœ€å¤§é˜»å¡nsè¿™ä¹ˆé•¿çš„æ—¶é—´æ¥è·å–ä¿¡å· // æˆåŠŸè¿”å›0ï¼Œå¤±è´¥è¿”å›å…¶ä»– func semasleep(ns int64) int32 { var start int64 // å¦‚æœæˆ‘ä»¬æœ‰æœ€å¤§è€—æ—¶ï¼Œæˆ‘ä»¬å°±è¦å…ˆè®°å½•ä¸€ä¸‹æˆ‘ä»¬è°ƒç”¨æ—¶å€™çš„æ—¶é—´ï¼Œæ–¹ä¾¿åé¢ç®—èŠ±è´¹äº†å¤šé•¿æ—¶é—´ if ns \u003e= 0 { start = nanotime() } // å¾—åˆ°m mp := getg().m // ä¸Šé” pthread_mutex_lock(\u0026mp.mutex) for { // mp.countåªæœ‰åœ¨å”¤é†’ä¸€ä¸ªä¿¡å·çš„æ—¶å€™æ‰ä¼šå¢åŠ  if mp.count \u003e 0 { // å¦‚æœé‡Œé¢å¾—åˆ°ä¸€ä¸ªä¿¡å·ï¼Œæˆ‘ä»¬å°±è®©å®ƒ-- mp.count-- // è§£é”å°±å¥½äº† pthread_mutex_unlock(\u0026mp.mutex) return 0 } // ns \u003e= 0 è¯´æ˜æˆ‘ä»¬æœ‰ä¸€ä¸ªè€—æ—¶æ£€æµ‹ if ns \u003e= 0 { // åˆ¤æ–­ä¸€ä¸‹æˆ‘ä»¬å½“å‰èŠ±è´¹çš„æ—¶é—´æ˜¯ä¸æ˜¯è¶…è¿‡æˆ‘ä»¬çš„è€—æ—¶äº† spent := nanotime() - start if spent \u003e= ns { // è¶…è¿‡æˆ‘ä»¬å°±è§£é”å¹¶è¿”å›-1 pthread_mutex_unlock(\u0026mp.mutex) return -1 } // tæ˜¯ä¸€ä¸ªæ—¶é—´é‡ var t timespec // è®¡ç®—å‰©ä½™tçš„å€¼ t.setNsec(ns - spent) // æˆ‘ä»¬å¼€å§‹ç­‰å¾…ä¸€ä¸ªæ¡ä»¶é€šçŸ¥ï¼Œè®©æˆ‘ä»¬èƒ½ç»§ç»­æ‰§è¡Œï¼Œæœ€é•¿é˜»å¡æ—¶é—´ä¸ºtï¼Œè¿™é‡Œé¢ä¼ å…¥mutexä¹Ÿæ˜¯ä¸ºäº†ä¸Šé”ï¼Œé‡Œé¢å¥½ä¿®æ”¹çŠ¶æ€ err := pthread_cond_timedwait_relative_np(\u0026mp.cond, \u0026mp.mutex, \u0026t) // å¦‚æœè¶…æ—¶ï¼Œæˆ‘ä»¬å°±è¿”å›-1 if err == _ETIMEDOUT { pthread_mutex_unlock(\u0026mp.mutex) return -1 } // æ²¡æœ‰è¶…æ—¶ï¼Œæˆ‘ä»¬å°±ç»§ç»­å¾ªç¯äº† // å¦‚æœæ²¡æœ‰è¶…æ—¶ï¼Œè¯æ˜condå¾—åˆ°äº†ä¸€ä¸ªé€šçŸ¥ï¼Œæˆ‘ä»¬çš„m.countæ˜¯ä¼š++çš„ï¼Œåœ¨ä¸Šé¢ä¼šæ­£å¸¸ç»“æŸè¿”å›0 } else { // å¦‚æœæˆ‘ä»¬è®©æ— é™ç­‰å¾…ï¼Œä¸”å½“å‰æ²¡æœ‰å¾—åˆ°ä¸€ä¸ªä¿¡å·ï¼Œæˆ‘ä»¬å°±ç›´æ¥ç­‰é€šçŸ¥å°±å¥½äº† pthread_cond_wait(\u0026mp.cond, \u0026mp.mutex) // æ‹¿åˆ°é€šçŸ¥åï¼Œå†å¾ªç¯åˆ°ä¸Šé¢countè‚¯å®šä¹Ÿä¼šå¤§äº0ï¼Œå°±è¿”å›0å°±å¥½äº† } } } semawakeup // å”¤é†’ä¸€ä¸ªä¿¡å·ï¼Œä¸ºæˆ‘ä»¬çš„count++ï¼Œå¹¶ä½¿ç”¨cond_signalè¿›è¡Œé€šçŸ¥ func semawakeup(mp *m) { // åŠ é”ï¼Œå› ä¸ºè¦æ“ä½œmäº† pthread_mutex_lock(\u0026mp.mutex) mp.count++ if mp.count \u003e 0 { // å¦‚æœcount\u003e0ï¼Œä»£è¡¨æŒæœ‰ä¿¡å·é‡ï¼Œæˆ‘ä»¬å°±é€šçŸ¥cond pthread_cond_signal(\u0026mp.cond) } pthread_mutex_unlock(\u0026mp.mutex) } ","date":"2022-09-04","objectID":"/4.-runtime%E4%B9%8Bmutex%E7%BA%BF%E7%A8%8B%E9%94%81%E7%9A%84%E5%AE%9E%E7%8E%B0/:1:1","tags":["runtime","goåº•å±‚å®ç°"],"title":"4. runtimeä¹‹mutexçº¿ç¨‹é”çš„å®ç°","uri":"/4.-runtime%E4%B9%8Bmutex%E7%BA%BF%E7%A8%8B%E9%94%81%E7%9A%84%E5%AE%9E%E7%8E%B0/"},{"categories":["go runtime"],"content":"mutex çš„åŠ è§£é”æ“ä½œ // locked ç”¨æœ€ä½ä½æ˜¯ä¸æ˜¯1æ¥åˆ¤æ–­æ˜¯å¦å¤„äºé”å®šçŠ¶æ€ // active_spin ç§¯æè‡ªæ—‹çš„æ¬¡æ•° // passive_spin æ¶ˆæè‡ªæ—‹çš„æ¬¡æ•° // active_spin_cnt ç”¨æ¥è‡ªæ—‹ç­‰å¾…çš„ const ( locked uintptr = 1 active_spin = 4 active_spin_cnt = 30 passive_spin = 1 ) è·å–é” lock func lock(l *mutex) { // lockWithRank åœ¨ç¬¬ä¸‰ç¯‡æ–‡ç« è®²åˆ°äº†ï¼Œå°±ä¸è¯´äº† // åˆ¤æ–­é”æ’åæ˜¯å¦åˆæ³• lockWithRank(l, getLockRank(l)) } // åŠ é”æ“ä½œ func lock2(l *mutex) { // å¾—åˆ°g gp := getg() // åˆ¤æ–­mä¸Šé”çš„æ•°é‡æ˜¯ä¸æ˜¯å¼‚å¸¸çš„ if gp.m.locks \u003c 0 { throw(\"runtimeÂ·lock: lock count\") } // ç»™lock++ gp.m.locks++ // casæ“ä½œï¼Œåˆ¤æ–­l.keyæ˜¯ä¸æ˜¯0ï¼Œå¦‚æœæ˜¯0ï¼Œæˆ‘ä»¬è®¾ç½®æˆlockedï¼Œå°±ç»“æŸäº† if atomic.Casuintptr(\u0026l.key, 0, locked) { return } // å¦‚æœä¸æ˜¯0ï¼Œæˆ‘ä»¬å…ˆåˆå§‹åŒ–ä¸€ä¸‹ä¿¡å·é‡ semacreate(gp.m) // å•æ ¸å¤„ç†å™¨ä¸è‡ªæ—‹ï¼Œå¤šæ ¸å¤„ç†å™¨è‡ªæ—‹ spin := 0 if ncpu \u003e 1 { // è‡ªæ—‹4æ¬¡ spin = active_spin } Loop: // è¿›å…¥ä¸€ä¸ªå¾ªç¯ for i := 0; ; i++ { // è·å–keyçš„å€¼ v := atomic.Loaduintptr(\u0026l.key) // åˆ¤æ–­keyçš„æœ€ä½ä½æ˜¯ä¸æ˜¯0 if v\u0026locked == 0 { // æ˜¯0çš„è¯ï¼Œè¯æ˜å¯ä»¥ç›´æ¥åŠ é” // æˆ‘ä»¬å°è¯•casåŠ é”ï¼Œå¦‚æœå¤±è´¥äº†ï¼Œæˆ‘ä»¬å°±è®©é‡æ–°å¼€å§‹è‡ªæ—‹ if atomic.Casuintptr(\u0026l.key, v, v|locked) { return } // å¦‚æœè¿˜æ˜¯è¢«é”å®šçš„ï¼Œæˆ‘ä»¬å°±é‡æ–°è‡ªæ—‹ i = 0 } if i \u003c spin { // i å¦‚æœå°äºè‡ªæ—‹æ¬¡æ•°ï¼Œè°ƒç”¨procyieldï¼Œèµ„æºæ¶ˆè€—å° // é˜»å¡ä¸€ä¸‹ procyield(active_spin_cnt) } else if i \u003c spin+passive_spin { // å¦‚æœiå¤§äºç­‰äºè‡ªæ—‹æ¬¡æ•°ï¼Œæˆ‘ä»¬åˆ¤æ–­æ˜¯ä¸æ˜¯è¿˜å°äºåŠ ä¸Šæ¶ˆæçš„è‡ªæ—‹æ¬¡æ•°ï¼Œå°±æ‰§è¡Œosyieldï¼Œèµ„æºæ¶ˆè€—å¤§ // é˜»å¡ä¸€ä¸‹ osyield() } else { // ä¸ç”¨è‡ªæ—‹äº†ï¼Œæˆ‘ä»¬è¦ç»™è¿™ä¸ªmutexè¿›è¡Œå…¥é˜Ÿç­‰å¾…äº† // l.key æŒ‚è½½çš„æ˜¯ç­‰å¾…è¿™ä¸ªé”çš„ m çš„é“¾è¡¨ // é€šè¿‡ nextwaitm æ¥æ’é˜Ÿ for { // gp.m.nextwaitm è®¾ç½®æˆçš„ vä¸­çš„mï¼Œä¹Ÿå°±æ˜¯åŸæ¥çš„m // l.keyè®¾ç½®æˆç°åœ¨çš„m // é‚£ä¹ˆå…³ç³»å°±æ˜¯l.keyæ˜¯ç°åœ¨çš„m // l.keyçš„mçš„nextwaitmæ˜¯ä¸Šä¸€ä¸ªmäº† // ç›¸å½“äºå…¥é˜Ÿåˆ°å¤´éƒ¨äº† gp.m.nextwaitm = muintptr(v \u0026^ locked) // å¦‚æœvåœ¨ä¸­é€”æ²¡æœ‰è¢«è§£é”ï¼Œæˆ‘ä»¬å°±æŠŠvè®¾ç½®æˆå½“å‰mçš„åœ°å€ï¼Œæœ€åä¸€ä½è®¾ç½®æˆé”å®šä¸­ if atomic.Casuintptr(\u0026l.key, v, uintptr(unsafe.Pointer(gp.m))|locked) { break } // å¦‚æœvè¢«å…¶ä»–çº¿ç¨‹æ”¹å˜äº†ï¼Œé‡æ–°å»ä¸€ä¸‹vçš„æ–°å€¼ï¼ˆå…¶ä»–çº¿ç¨‹å¯èƒ½è§£é”äº†è¿™ä¸ªvï¼‰ v = atomic.Loaduintptr(\u0026l.key) // å¦‚æœvå½“å‰å¤„äºè§£é”çŠ¶æ€äº† if v\u0026locked == 0 { // ç»§ç»­å¤–éƒ¨å¾ªç¯äº† continue Loop } } // å¦‚æœvé”å®šä¸­ï¼Œæˆ‘ä»¬å°±æŒ‚èµ·ç­‰å¾… if v\u0026locked != 0 { // ç­‰å¾… semasleep(-1) i = 0 } } } } å½“ä¸€ä¸ªçº¿ç¨‹éœ€è¦è·å–ä¸€ä¸ªé”çš„æ—¶å€™ï¼Œä»–æ‰§è¡Œæµç¨‹å¦‚ä¸‹ åˆ¤æ–­keyçš„å€¼ç­‰äº0ï¼ˆä¹Ÿå°±æ˜¯ä¸€ä¸ªæ–°é”ï¼‰ï¼Œé‚£ä¹ˆå°±ç›´æ¥è®¾ç½®ä¸º1é”å®šçŠ¶æ€ï¼Œå¹¶è¿”å› å¦‚æœkeyä¸æ˜¯0ï¼Œè¯æ˜é‡Œé¢è¦ä¹ˆæ˜¯1ï¼Œè¦ä¹ˆæ˜¯å­˜äº†ä¸€ä¸ªwaitmï¼Œæˆ‘ä»¬å°±è¦åˆå§‹åŒ–ä¿¡å·é”ï¼ˆæ›´åº•å±‚ï¼Œä»…ä¼šåˆå§‹åŒ–ä¸€æ¬¡ï¼‰ è·å–æ˜¯å¦åº”è¯¥è‡ªæ—‹å’Œè®¾ç½®è‡ªæ—‹æ¬¡æ•° è¿›å…¥è‡ªæ—‹ä¹Ÿå°±æ˜¯å¾ªç¯ï¼Œæ­¤æ—¶keyå¯èƒ½æ˜¯1æˆ–è€…æ˜¯ä¸€ä¸ªwaitmï¼Œwaitmçš„æœ€ä½ä½æ ‡å¿—ç€å½“å‰é”çš„çŠ¶æ€ï¼Œæˆ‘ä»¬åˆ¤æ–­æœ€ä½ä½ç­‰äº0ï¼Œæˆ‘ä»¬ç›´æ¥è®¾ç½®æœ€ä½ä½ä¸º1ï¼Œè¿”å›å³å¯ å¦‚æœè®¾ç½®æœ€ä½ä½ä¸º1å¤±è´¥ï¼ˆå…¶ä»–çº¿ç¨‹æŠ¢å…ˆä¸€æ­¥ä¿®æ”¹äº†ï¼‰ï¼Œæˆ‘ä»¬éœ€è¦é‡æ–°è‡ªæ—‹ åœ¨ä¸Šä¸€æ­¥éªŒè¯ç»“æŸåï¼Œå¦‚æœè‡ªæ—‹æ¬¡æ•°è¿˜æœªå¾ªç¯ç»“æŸï¼Œæˆ‘ä»¬è®©å¤„ç†å™¨æ‰§è¡Œç­‰å¾…ï¼Œåç»§ç»­å¾ªç¯è·å–é”çŠ¶æ€ å¦‚æœè‡ªæ—‹æ¬¡æ•°ç»“æŸï¼Œæ— æ³•è·å–åˆ°é”ï¼Œæˆ‘ä»¬å°±è®©å½“å‰mçš„nextwaitmæŒ‡å‘keyï¼Œä¹Ÿå°±æ˜¯å‰é¢æ­£åœ¨é˜»å¡çš„mçš„åœ°å€ï¼Œè®©æˆ‘ä»¬çš„keyå­˜å‚¨å½“å‰mçš„åœ°å€ å¦‚æœå­˜å‚¨æˆ‘ä»¬çš„må¤±è´¥ï¼Œè¯æ˜å½“å‰é”å·²ç»è¢«å…¶ä»–çº¿ç¨‹é‡Šæ”¾äº†ï¼Œæˆ‘ä»¬å°±ç»§ç»­åˆ¤æ–­ï¼Œé‡æ–°è¿›å…¥è‡ªæ—‹çŠ¶æ€ å¦‚æœå­˜å‚¨æˆåŠŸï¼Œæˆ‘ä»¬å°±ç­‰å¾…semaä¿¡å·çš„é€šçŸ¥å³å¯ ä¸ºä»€ä¹ˆmè¦é€šè¿‡é‚£ç§æ–¹å¼è®¾ç½®ï¼Œæˆ‘ä»¬ä¸¾ä¸ªä¾‹å­ï¼Œä»–è¿™ä¸ªç®—æ³•å¾ˆå·§å¦™ã€‚ åœ°å€ä¸è®¡ç®— å¤‡æ³¨ m 0x1000 må°±æ˜¯æˆ‘ä»¬çš„çº¿ç¨‹åœ°å€ waitm 0x1001 (0x1000 \u0026^ 0x1) waitmå°±æ˜¯æˆ‘ä»¬çš„nextwaitm key 0x1001 (0x1000 | 0x1) keyå°±æ˜¯mutexé‡Œé¢å­˜å‚¨çš„ getm 0x1000 (0x1001 \u0026^ 0x1) getmå°±æ˜¯é‡Šæ”¾é”æ—¶ä»keyé‡Œå–åˆ°çš„m é‡Šæ”¾é” func unlock(l *mutex) { unlockWithRank(l) } func unlock2(l *mutex) { // è·å–g gp := getg() var mp *m for { // è·å–é”ä¸Šå­˜çš„keyï¼Œä¹Ÿå°±æ˜¯waitmä»¥åŠé”å®šçŠ¶æ€ v := atomic.Loaduintptr(\u0026l.key) // å¦‚æœé”å®šä¸­ï¼Œç›´æ¥è§£é” if v == locked { // casæ“ä½œè§£é” if atomic.Casuintptr(\u0026l.key, locked, 0) { break } } else { // å½“å‰vä¸æ˜¯å•çº¯çš„é”å®šçŠ¶æ€ï¼Œé‡Œé¢å­˜å‚¨äº†mä¿¡æ¯ // å–åˆ°mçš„æŒ‡é’ˆ mp = muintptr(v \u0026^ locked).ptr() // è®©æˆ‘ä»¬çš„keyæŒ‡å‘ä¸‹ä¸€ä¸ªç­‰å¾…çš„mèº«ä¸Š if atomic.Casuintptr(\u0026l.key, v, uintptr(mp.nextwaitm)) { // å”¤é†’mp semawakeup(mp) break } } } // è§£é”æˆåŠŸ gp.m.locks-- if gp.m.locks \u003c 0 { throw(\"runtimeÂ·unlock: lock count\") } // å¦‚æœmä¸Šæ²¡æœ‰é”äº†ï¼Œå°±æ¢å¤æŠ¢å è¯·æ±‚ if gp.m.locks == 0 \u0026\u0026 gp.preempt { // restore the preemption request in case we've cleared it in newstack gp.stackguard0 = stackPreempt } } ","date":"2022-09-04","objectID":"/4.-runtime%E4%B9%8Bmutex%E7%BA%BF%E7%A8%8B%E9%94%81%E7%9A%84%E5%AE%9E%E7%8E%B0/:1:2","tags":["runtime","goåº•å±‚å®ç°"],"title":"4. runtimeä¹‹mutexçº¿ç¨‹é”çš„å®ç°","uri":"/4.-runtime%E4%B9%8Bmutex%E7%BA%BF%E7%A8%8B%E9%94%81%E7%9A%84%E5%AE%9E%E7%8E%B0/"},{"categories":["go runtime"],"content":"mutexåŸºäºfutexçš„å®ç° ","date":"2022-09-04","objectID":"/4.-runtime%E4%B9%8Bmutex%E7%BA%BF%E7%A8%8B%E9%94%81%E7%9A%84%E5%AE%9E%E7%8E%B0/:2:0","tags":["runtime","goåº•å±‚å®ç°"],"title":"4. runtimeä¹‹mutexçº¿ç¨‹é”çš„å®ç°","uri":"/4.-runtime%E4%B9%8Bmutex%E7%BA%BF%E7%A8%8B%E9%94%81%E7%9A%84%E5%AE%9E%E7%8E%B0/"},{"categories":["go runtime"],"content":"è·å–é” func lock(l *mutex) { lockWithRank(l, getLockRank(l)) } func lock2(l *mutex) { // æ‹¿åˆ°g gp := getg() if gp.m.locks \u003c 0 { throw(\"runtimeÂ·lock: lock count\") } gp.m.locks++ // æŠŠl.keyè®¾ç½®æˆmutex_locked v := atomic.Xchg(key32(\u0026l.key), mutex_locked) // åˆ¤æ–­åŸæ¥l.keyæ˜¯ä¸æ˜¯è§£é”çŠ¶æ€ï¼Œæ‹¿åˆ°é”äº† if v == mutex_unlocked { return } // wait ç°åœ¨æ˜¯ MUTEX_LOCKED æˆ–è€… MUTEX_SLEEPINGçŠ¶æ€ wait := v spin := 0 if ncpu \u003e 1 { spin = active_spin } for { // ç§¯æè‡ªæ—‹ï¼Œå†æ¬¡å°è¯•è§£é” for i := 0; i \u003c spin; i++ { // å¦‚æœå…¶ä»–çº¿ç¨‹æŠŠé”é‡Šæ”¾äº†ï¼Œæˆ‘ä»¬è¿™è¾¹å°±èƒ½æ‹¿åˆ°äº†ï¼Œå¹¶ä¸”æŠŠé”çŠ¶æ€ï¼Œè®¾ç½®æˆæˆ‘ä»¬ä¸Šé¢æœ¬æ¥çš„çŠ¶æ€ for l.key == mutex_unlocked { if atomic.Cas(key32(\u0026l.key), mutex_unlocked, wait) { return } } procyield(active_spin_cnt) } // æ¶ˆæè‡ªæ—‹ï¼Œä¸ä¸Šé¢ç›¸åŒï¼Œå°±æ˜¯æ¢æˆäº†osyield for i := 0; i \u003c passive_spin; i++ { for l.key == mutex_unlocked { if atomic.Cas(key32(\u0026l.key), mutex_unlocked, wait) { return } } osyield() } // æˆ‘ä»¬å†è·å–ä¸€æ¬¡ï¼Œè·å–åˆ°äº†å°±okï¼Œå†æŒ‚è½½åˆ°futexçš„æ—¶å€™ä¸€å®šæ˜¯sleepingçŠ¶æ€ v = atomic.Xchg(key32(\u0026l.key), mutex_sleeping) if v == mutex_unlocked { return } // æ¥åˆ°è¿™å—ï¼Œè¯æ˜æˆ‘ä»¬çš„é”è·å–ä¸åˆ°äº†ï¼Œæˆ‘ä»¬è¦å»ç¡çœ äº† wait = mutex_sleeping futexsleep(key32(\u0026l.key), mutex_sleeping, -1) } } ","date":"2022-09-04","objectID":"/4.-runtime%E4%B9%8Bmutex%E7%BA%BF%E7%A8%8B%E9%94%81%E7%9A%84%E5%AE%9E%E7%8E%B0/:2:1","tags":["runtime","goåº•å±‚å®ç°"],"title":"4. runtimeä¹‹mutexçº¿ç¨‹é”çš„å®ç°","uri":"/4.-runtime%E4%B9%8Bmutex%E7%BA%BF%E7%A8%8B%E9%94%81%E7%9A%84%E5%AE%9E%E7%8E%B0/"},{"categories":["go runtime"],"content":"é‡Šæ”¾é” func unlock(l *mutex) { unlockWithRank(l) } func unlock2(l *mutex) { // æŠŠé”è®¾ç½®æˆmutex_unlocked v := atomic.Xchg(key32(\u0026l.key), mutex_unlocked) // åˆ¤æ–­åŸæ¥æ˜¯ä¸æ˜¯å°±æ˜¯è§£é”çŠ¶æ€ if v == mutex_unlocked { throw(\"unlock of unlocked lock\") } // å¦‚æœé”åœ¨ç¡çœ ä¸­ï¼Œæˆ‘ä»¬å°±å”¤é†’ä¸€ä¸ª if v == mutex_sleeping { futexwakeup(key32(\u0026l.key), 1) } gp := getg() gp.m.locks-- if gp.m.locks \u003c 0 { throw(\"runtimeÂ·unlock: lock count\") } if gp.m.locks == 0 \u0026\u0026 gp.preempt { // restore the preemption request in case we've cleared it in newstack gp.stackguard0 = stackPreempt } } ","date":"2022-09-04","objectID":"/4.-runtime%E4%B9%8Bmutex%E7%BA%BF%E7%A8%8B%E9%94%81%E7%9A%84%E5%AE%9E%E7%8E%B0/:2:2","tags":["runtime","goåº•å±‚å®ç°"],"title":"4. runtimeä¹‹mutexçº¿ç¨‹é”çš„å®ç°","uri":"/4.-runtime%E4%B9%8Bmutex%E7%BA%BF%E7%A8%8B%E9%94%81%E7%9A%84%E5%AE%9E%E7%8E%B0/"},{"categories":["go runtime"],"content":"åœ¨runtime.mutexä¸­å†…åµŒäº†ä¸€ä¸ªå«lockRankStructçš„ç»“æ„ä½“ï¼Œçœ‹åå­—æˆ‘ä»¬å°±çŸ¥é“æ˜¯åšé”æ’åçš„ã€‚mutexæˆ‘ä»¬åœ¨runtimeç³»åˆ—çš„ç¬¬å››ç¯‡æ–‡ç« è®²åˆ°ã€‚ å®ƒå…¶å®å¾ˆç®€å•ï¼Œä¸€å¼€å§‹æˆ‘ä»¬çš„é”ï¼Œåªèƒ½æœ‰ä¸€ä¸ªäººæŒæœ‰ï¼Œç­‰ä»–é‡Šæ”¾äº†ï¼Œå…¶ä»–äººæ‰èƒ½æ¥è·å–é”ã€‚ ç°åœ¨æœ‰äº†è¿™ä¸ªé”æ’åæœºåˆ¶ï¼Œå½“æˆ‘ä»¬è¦æ¥è·å–é”çš„æ—¶å€™ï¼Œæˆ‘ä»¬é¦–å…ˆçœ‹è¿™ä¸ªé”æœ‰æ²¡æœ‰è¢«æŒæœ‰ï¼Œæœ€åæ¥çš„ä¸€ä¸ªæŒæœ‰è¿™ä¸ªé”çš„äººçš„ç­‰çº§æ˜¯ä¸æ˜¯æ¯”æˆ‘ä»¬ä½ï¼Œå¦‚æœæ¯”æˆ‘ä»¬ä½çš„è¯ï¼Œæˆ‘ä»¬è¦å»æŸ¥ä¸€ä¸‹æˆ‘ä»¬çš„è¡¨ï¼Œçœ‹çœ‹å½“ä»–æŒæœ‰é”çš„æ—¶å€™ï¼Œæˆ‘ä»¬èƒ½ä¸èƒ½ç»§ç»­è·å–é”ã€‚å¦‚æœèƒ½ï¼Œæˆ‘ä»¬å°±èƒ½ç›´æ¥è·å–é”ã€‚ è¿™ä¸ªé™æ€æ’åæ£€æŸ¥åŠŸèƒ½ï¼Œæˆ‘ä»¬è¦åœ¨GOEXPERIMENTå¼€å¯staticklockrankingæ‰æœ‰æ•ˆ ","date":"2022-09-04","objectID":"/3.-runtime%E4%B9%8Blockrank%E9%94%81%E6%8E%92%E5%90%8D%E6%9C%BA%E5%88%B6/:0:0","tags":["runtime","goåº•å±‚å®ç°"],"title":"3. runtimeä¹‹lockRanké”æ’åæœºåˆ¶","uri":"/3.-runtime%E4%B9%8Blockrank%E9%94%81%E6%8E%92%E5%90%8D%E6%9C%BA%E5%88%B6/"},{"categories":["go runtime"],"content":"æ’åç»“æ„ // é”çš„æ’åæœ¬è´¨å°±æ˜¯ä¸€ä¸ªæ•°å­— type lockRank int // åŒ…è£…äº†ä¸€ä¸ªæ’åç»“æ„ï¼Œé‡Œé¢çš„padæ˜¯ç”¨æ¥å¡«å……ï¼Œè®©lockRankStructæ˜¯8å­—èŠ‚çš„ type lockRankStruct struct { rank lockRank pad int } // è¿™å°±æ˜¯æˆ‘ä»¬æŸ¥è¯¢æ˜¯å¦èƒ½åŒæ—¶æŒæœ‰é”çš„ä¸€ä¸ªè¡¨ // ä¸€ç»´æ•°ç»„è¡¨ç¤ºä¸åŒçš„é”ï¼Œé‡Œé¢å­˜ç€å®ƒä»¬çš„ç­‰çº§ï¼Œåˆšå¥½å®ƒä»¬çš„ä¸‹æ ‡ä¹Ÿæ˜¯å®ƒä»¬çš„ç­‰çº§ // äºŒç»´æ•°ç»„å°±æ˜¯å½“æˆ‘ä»¬è¦æŒæœ‰é”çš„æ—¶å€™æŸ¥è¯¢è¡¨æ¥çœ‹çœ‹å‰ä¸€ä¸ªæ˜¯ä¸æ˜¯åœ¨è‡ªå·±çš„åˆæ³•é”é‡Œé¢ï¼Œå¦‚æœä¸åœ¨ï¼Œæˆ‘ä»¬ä¹Ÿä¸èƒ½åŒæ—¶æŒæœ‰è¿™ä¸¤ä¸ªé” var lockPartialOrder [][]lockRank = [][]lockRank{ lockRankDummy: {}, lockRankSysmon: {}, lockRankScavenge: {lockRankSysmon}, lockRankForcegc: {lockRankSysmon}, lockRankSweepWaiters: {}, lockRankAssistQueue: {}, lockRankCpuprof: {}, lockRankSweep: {}, lockRankPollDesc: {}, lockRankSched: {lockRankSysmon, lockRankScavenge, lockRankForcegc, lockRankSweepWaiters, lockRankAssistQueue, lockRankCpuprof, lockRankSweep, lockRankPollDesc}, lockRankDeadlock: {lockRankDeadlock}, lockRankAllg: {lockRankSysmon, lockRankSched}, lockRankAllp: {lockRankSysmon, lockRankSched}, lockRankTimers: {lockRankSysmon, lockRankScavenge, lockRankPollDesc, lockRankSched, lockRankAllp, lockRankTimers}, lockRankItab: {}, lockRankReflectOffs: {lockRankItab}, lockRankHchan: {lockRankScavenge, lockRankSweep, lockRankHchan}, lockRankTraceBuf: {lockRankSysmon, lockRankScavenge}, lockRankFin: {lockRankSysmon, lockRankScavenge, lockRankSched, lockRankAllg, lockRankTimers, lockRankReflectOffs, lockRankHchan, lockRankTraceBuf}, lockRankNotifyList: {}, lockRankTraceStrings: {lockRankTraceBuf}, lockRankMspanSpecial: {lockRankSysmon, lockRankScavenge, lockRankAssistQueue, lockRankCpuprof, lockRankSweep, lockRankSched, lockRankAllg, lockRankAllp, lockRankTimers, lockRankItab, lockRankReflectOffs, lockRankHchan, lockRankTraceBuf, lockRankNotifyList, lockRankTraceStrings}, lockRankProf: {lockRankSysmon, lockRankScavenge, lockRankAssistQueue, lockRankCpuprof, lockRankSweep, lockRankSched, lockRankAllg, lockRankAllp, lockRankTimers, lockRankItab, lockRankReflectOffs, lockRankHchan, lockRankTraceBuf, lockRankNotifyList, lockRankTraceStrings}, lockRankGcBitsArenas: {lockRankSysmon, lockRankScavenge, lockRankAssistQueue, lockRankCpuprof, lockRankSched, lockRankAllg, lockRankTimers, lockRankItab, lockRankReflectOffs, lockRankHchan, lockRankTraceBuf, lockRankNotifyList, lockRankTraceStrings}, lockRankRoot: {}, lockRankTrace: {lockRankSysmon, lockRankScavenge, lockRankForcegc, lockRankAssistQueue, lockRankSweep, lockRankSched, lockRankHchan, lockRankTraceBuf, lockRankTraceStrings, lockRankRoot}, lockRankTraceStackTab: {lockRankScavenge, lockRankForcegc, lockRankSweepWaiters, lockRankAssistQueue, lockRankSweep, lockRankSched, lockRankAllg, lockRankTimers, lockRankHchan, lockRankTraceBuf, lockRankFin, lockRankNotifyList, lockRankTraceStrings, lockRankRoot, lockRankTrace}, lockRankNetpollInit: {lockRankTimers}, lockRankRwmutexW: {}, lockRankRwmutexR: {lockRankSysmon, lockRankRwmutexW}, lockRankSpanSetSpine: {lockRankSysmon, lockRankScavenge, lockRankForcegc, lockRankAssistQueue, lockRankCpuprof, lockRankSweep, lockRankPollDesc, lockRankSched, lockRankAllg, lockRankAllp, lockRankTimers, lockRankItab, lockRankReflectOffs, lockRankHchan, lockRankTraceBuf, lockRankNotifyList, lockRankTraceStrings}, lockRankGscan: {lockRankSysmon, lockRankScavenge, lockRankForcegc, lockRankSweepWaiters, lockRankAssistQueue, lockRankCpuprof, lockRankSweep, lockRankPollDesc, lockRankSched, lockRankTimers, lockRankItab, lockRankReflectOffs, lockRankHchan, lockRankTraceBuf, lockRankFin, lockRankNotifyList, lockRankTraceStrings, lockRankProf, lockRankGcBitsArenas, lockRankRoot, lockRankTrace, lockRankTraceStackTab, lockRankNetpollInit, lockRankSpanSetSpine}, lockRankStackpool: {lockRankSysmon, lockRankScavenge, lockRankSweepWaiters, lockRankAssistQueue, lockRankCpuprof, lockRankSweep, lockRankPollDesc, lockRankSched, lockRankTimers, lockRankItab, lockRankReflectOffs, lockRankHchan, lockRankTraceBuf, lockRankFin, lockRankNotifyList, lockRankTraceStrings, lockRankProf, lockRankGcBitsArenas, lockRankRoot, lockRankTrace, lockRankTraceStackTab, lockRankNetpollInit, lockRankRwmutexR, lockRankSpanSetSpine, lockRankGscan}, lockRankStackLarge: {lockRankSysmon, loc","date":"2022-09-04","objectID":"/3.-runtime%E4%B9%8Blockrank%E9%94%81%E6%8E%92%E5%90%8D%E6%9C%BA%E5%88%B6/:1:0","tags":["runtime","goåº•å±‚å®ç°"],"title":"3. runtimeä¹‹lockRanké”æ’åæœºåˆ¶","uri":"/3.-runtime%E4%B9%8Blockrank%E9%94%81%E6%8E%92%E5%90%8D%E6%9C%BA%E5%88%B6/"},{"categories":["go runtime"],"content":"é”æ’åçš„åˆå§‹åŒ– // å…¶å®å°±æ˜¯ç»™mutexä¸ŠåŠ ä¸Šäº†è¿™ä¸ªæ’åæ•°å­— func lockInit(l *mutex, rank lockRank) { l.rank = rank } ","date":"2022-09-04","objectID":"/3.-runtime%E4%B9%8Blockrank%E9%94%81%E6%8E%92%E5%90%8D%E6%9C%BA%E5%88%B6/:2:0","tags":["runtime","goåº•å±‚å®ç°"],"title":"3. runtimeä¹‹lockRanké”æ’åæœºåˆ¶","uri":"/3.-runtime%E4%B9%8Blockrank%E9%94%81%E6%8E%92%E5%90%8D%E6%9C%BA%E5%88%B6/"},{"categories":["go runtime"],"content":"ç›´æ¥è·å–é”ä¸Šé¢çš„æ’å func getLockRank(l *mutex) lockRank { return l.rank } ","date":"2022-09-04","objectID":"/3.-runtime%E4%B9%8Blockrank%E9%94%81%E6%8E%92%E5%90%8D%E6%9C%BA%E5%88%B6/:3:0","tags":["runtime","goåº•å±‚å®ç°"],"title":"3. runtimeä¹‹lockRanké”æ’åæœºåˆ¶","uri":"/3.-runtime%E4%B9%8Blockrank%E9%94%81%E6%8E%92%E5%90%8D%E6%9C%BA%E5%88%B6/"},{"categories":["go runtime"],"content":"å¸¦æ’ååŠ é” å°±æ˜¯æ£€æŸ¥è¿™ä¸ªæ’åçš„é”èƒ½ä¸èƒ½åˆæ³•çš„lockï¼Œå¦‚æœå¯ä»¥å°±lock // ç¬¬äºŒä¸ªå‚æ•°å°±æ˜¯æˆ‘ä»¬é”æ’å func lockWithRank(l *mutex, rank lockRank) { if l == \u0026debuglock || l == \u0026paniclk { // è¿™ä¿©ä¸œè¥¿ä¸è¦åšæ’å // debuglockæ˜¯è°ƒè¯•è¾“å‡ºæˆ‘ä»¬å½“å‰mä¸Šé¢æŒæœ‰é”å’Œæ’åä¿¡æ¯çš„ // paniclkåŒç†ä¹Ÿå·®ä¸å¤šï¼Œæ˜¯å¼‚å¸¸é”™è¯¯åæ‰§è¡Œçš„ // lock2å’Œunlock2éƒ½æ˜¯å’Œmutexæœ‰å…³çš„ï¼Œç¬¬å››ç¯‡æ–‡ç« è®²åˆ° lock2(l) return } // å¦‚æœrank == 0ï¼Œæˆ‘ä»¬çš„rankå°±æ˜¯ä¸€ä¸ªæ•°å€¼æœ€å¤§çš„é”ï¼Œå®ƒåªä¼šåˆ¤æ–­å‰ä¸€ä¸ªé”æ˜¯ä¸æ˜¯lockRankLeafRankæ¥å†³å®šèƒ½ä¸èƒ½è·å–é” if rank == 0 { rank = lockRankLeafRank } // è·å–æˆ‘ä»¬æ‰§è¡Œçš„g gp := getg() // åˆ‡æ¢ç³»ç»Ÿæ ˆï¼Œä¹Ÿå°±æ˜¯g0çš„æ ˆä¸­æ‰§è¡Œä¸‹é¢ systemstack(func() { // iæ˜¯æˆ‘ä»¬gpä¸Šé¢æŒæœ‰çš„é”ä¿¡æ¯é•¿åº¦ i := gp.m.locksHeldLen // å¦‚æœæˆ‘ä»¬locksHeldLenæ˜¾ç¤ºçš„é•¿åº¦\u003e=10ï¼Œé‚£ä¹ˆå°±æŠ¥é”™ // m æŒæœ‰æœ€å¤š 10 ä¸ªé”ï¼Œç”±é”æ’åä»£ç ç»´æŠ¤ã€‚ if i \u003e= len(gp.m.locksHeld) { throw(\"too many locks held concurrently for rank checking\") } // æŠŠè¿™ä¸ªé”ä¿¡æ¯ï¼ˆæ’åå’Œé”åœ°å€ï¼‰è®°å½•åˆ°mä¸Š gp.m.locksHeld[i].rank = rank gp.m.locksHeld[i].lockAddr = uintptr(unsafe.Pointer(l)) gp.m.locksHeldLen++ // i==0çš„è¯ï¼Œè¯æ˜æ˜¯ç¬¬ä¸€ä¸ªé”ï¼Œç›´æ¥æ”¾ä¸Šå»å°±å¥½äº†ï¼Œä¸ç”¨æ£€æŸ¥çš„ // i \u003e 0çš„è¯ï¼Œè¯æ˜ä¸æ˜¯ç¬¬ä¸€ä¸ªé”ï¼Œæˆ‘ä»¬å°±è¦åˆ¤æ–­æˆ‘ä»¬æ–°é”èƒ½ä¸èƒ½åŠ å…¥è¿›æ¥ if i \u003e 0 { checkRanks(gp, gp.m.locksHeld[i-1].rank, rank) } // å¦‚æœèƒ½åŠ å…¥è¿›æ¥ï¼Œæˆ‘ä»¬å°±ä¸Šé”äº† lock2(l) }) } ç›¸åŒçš„è¿˜æœ‰ä¸€ä¸ªå‡½æ•°func acquireLockRank(rank lockRank)ä»–åªæ˜¯åˆ¤æ–­æ’åæ˜¯å¦åˆæ³•ï¼Œç„¶åæŠŠæ’åä¿¡æ¯æŒ‚è½½åˆ°mä¸Šå»ï¼Œä¸è¿›è¡Œé”æ“ä½œï¼Œå› ä¸ºå®ƒä¹Ÿæ²¡ç»™ä¼ ä¸€ä¸ªé”ï¼Œå†…éƒ¨é€»è¾‘å…¶å®æ˜¯ä¸€æ ·çš„ ","date":"2022-09-04","objectID":"/3.-runtime%E4%B9%8Blockrank%E9%94%81%E6%8E%92%E5%90%8D%E6%9C%BA%E5%88%B6/:4:0","tags":["runtime","goåº•å±‚å®ç°"],"title":"3. runtimeä¹‹lockRanké”æ’åæœºåˆ¶","uri":"/3.-runtime%E4%B9%8Blockrank%E9%94%81%E6%8E%92%E5%90%8D%E6%9C%BA%E5%88%B6/"},{"categories":["go runtime"],"content":"çœŸæ­£çš„é”æ’åæ£€æŸ¥æœºåˆ¶ func checkRanks(gp *g, prevRank, rank lockRank) { // ä¸€å¼€å§‹è®¾ç½®æˆ‘ä»¬çš„rankOKä¸ºfalse rankOK := false // prevRankæ˜¯å‰ä¸€ä¸ªé”çš„ç­‰çº§ï¼Œrankæ˜¯æˆ‘ä»¬ç°åœ¨è¦æ¥çš„é”ç­‰çº§ if rank \u003c prevRank { // æˆ‘ä»¬æ–°æ¥çš„é”æ¯”å‰ä¸€ä¸ªé”çš„ç­‰çº§ä½ï¼Œæˆ‘ä»¬ä¸èƒ½ä¸Šé” rankOK = false } else if rank == lockRankLeafRank { // æˆ‘ä»¬æ–°æ¥çš„é”ï¼Œæ˜¯ä¸€ä¸ªæœ€å¤§é”ï¼Œæˆ‘ä»¬å°±åˆ¤æ–­å‰ä¸€ä¸ªä¸æ˜¯æœ€å¤§é”å°±è¡Œäº† rankOK = prevRank \u003c lockRankLeafRank } else { // æ¥åˆ°è¿™å—è¯æ˜æˆ‘ä»¬çš„æ–°æ¥çš„é”æ¯”å‰ä¸€ä¸ªé”ç­‰çº§è¦é«˜ï¼Œæˆ‘ä»¬å¾—æŸ¥è¡¨çœ‹çœ‹ä»–ä»¬èƒ½ä¸èƒ½ä¸€èµ·ä½¿ç”¨ // lockPartialOrderæ˜¯ä¸€ä¸ªäºŒç»´æ•°ç»„ï¼Œæˆ‘ä»¬åœ¨ä¸Šé¢çœ‹åˆ°è¿‡ list := lockPartialOrder[rank] for _, entry := range list { // åˆ¤æ–­æˆ‘ä»¬çš„å‰ä¸€ä¸ªé”ï¼Œæœ‰æ²¡æœ‰å‡ºç°åœ¨è‡ªå·±çš„åˆæ³•åˆ—è¡¨é‡Œé¢ï¼Œå¦‚æœå‡ºç°äº†é‚£ä¹ˆå°±æ˜¯true if entry == prevRank { rankOK = true break } } } // å¦‚æœæ²¡å‡ºç°ï¼Œå°±æ‰“å°è°ƒè¯•ä¿¡æ¯ï¼ŒæŠ¥é”™å°±å¥½äº† if !rankOK { printlock() println(gp.m.procid, \" ======\") printHeldLocks(gp) throw(\"lock ordering problem\") } } ","date":"2022-09-04","objectID":"/3.-runtime%E4%B9%8Blockrank%E9%94%81%E6%8E%92%E5%90%8D%E6%9C%BA%E5%88%B6/:5:0","tags":["runtime","goåº•å±‚å®ç°"],"title":"3. runtimeä¹‹lockRanké”æ’åæœºåˆ¶","uri":"/3.-runtime%E4%B9%8Blockrank%E9%94%81%E6%8E%92%E5%90%8D%E6%9C%BA%E5%88%B6/"},{"categories":["go runtime"],"content":"é‡Šæ”¾é”ä»¥åŠæ’åä¿¡æ¯ å¦‚æœæˆ‘ä»¬å¼€å¯staticklockrankingåŠŸèƒ½åï¼Œæˆ‘ä»¬çš„è§£é”éœ€è¦æŠŠmä¸Šé¢æŒ‚åœ¨çš„é”ä¿¡æ¯ä¹Ÿç»™åˆ ä¸€ä¸‹ func unlockWithRank(l *mutex) { if l == \u0026debuglock || l == \u0026paniclk { // ä¸lockWithRankåŒç† unlock2(l) return } // ä¸‹é¢å°±æ˜¯ç®€å•çš„æ‘˜æ‰ä¸€ä¸ªé”çš„è¿‡ç¨‹ gp := getg() systemstack(func() { found := false for i := gp.m.locksHeldLen - 1; i \u003e= 0; i-- { if gp.m.locksHeld[i].lockAddr == uintptr(unsafe.Pointer(l)) { // æˆ‘ä»¬è¦çš„é”æ‰¾åˆ°äº† found = true copy(gp.m.locksHeld[i:gp.m.locksHeldLen-1], gp.m.locksHeld[i+1:gp.m.locksHeldLen]) gp.m.locksHeldLen-- break } } // æ²¡æ‰¾åˆ°çš„è¯ï¼Œå°±è°ƒè¯•ï¼Œè¿˜æœ‰æŠ¥é”™ if !found { println(gp.m.procid, \":\", l.rank.String(), l.rank, l) throw(\"unlock without matching lock acquire\") } // è§£é” unlock2(l) }) } ç›¸åŒçš„è¿˜æœ‰ä¸€ä¸ªå‡½æ•°func releaseLockRank(rank lockRank)ä»–åªæ˜¯é‡Šæ”¾mä¸Šé¢ç»‘å®šçš„ä¸€ä¸ªæ’åä¿¡æ¯ï¼Œé”åœ°å€æ˜¯0çš„ä¸€ä¸ªç©æ„ã€‚ä¸acquireLockRankå¯¹ç…§ ","date":"2022-09-04","objectID":"/3.-runtime%E4%B9%8Blockrank%E9%94%81%E6%8E%92%E5%90%8D%E6%9C%BA%E5%88%B6/:6:0","tags":["runtime","goåº•å±‚å®ç°"],"title":"3. runtimeä¹‹lockRanké”æ’åæœºåˆ¶","uri":"/3.-runtime%E4%B9%8Blockrank%E9%94%81%E6%8E%92%E5%90%8D%E6%9C%BA%E5%88%B6/"},{"categories":["go runtime"],"content":"åˆ¤æ–­æ’ååˆä¸åˆæ³• ä¸åšä»»ä½•æ“ä½œä¹Ÿä¸å¾€mä¸ŠæŒ‚è½½é”ä¿¡æ¯ // lockWithRankMayAcquire åˆ¤æ–­é”æ’åæ˜¯å¦åˆæ³•ï¼Œä¸åˆæ³•å°±æŠ¥é”™ func lockWithRankMayAcquire(l *mutex, rank lockRank) { // æ‹¿åˆ°g gp := getg() // åˆ¤æ–­æœ‰æ²¡æœ‰é” if gp.m.locksHeldLen == 0 { // æ²¡æœ‰é”ï¼Œä¸å¯èƒ½å‡ºç°é”æ’åºå‡ºé”™é—®é¢˜ return } // åˆ‡æ¢ç³»ç»Ÿæ ˆ systemstack(func() { i := gp.m.locksHeldLen if i \u003e= len(gp.m.locksHeld) { throw(\"too many locks held concurrently for rank checking\") } // è¿™è¾¹å°±æ˜¯ä¸´æ—¶æŒ‚è½½ä¸Šå»ï¼Œç„¶ååšäº†ä¸€ä¸ªåˆ¤æ–­ gp.m.locksHeld[i].rank = rank gp.m.locksHeld[i].lockAddr = uintptr(unsafe.Pointer(l)) gp.m.locksHeldLen++ checkRanks(gp, gp.m.locksHeld[i-1].rank, rank) gp.m.locksHeldLen-- }) } ","date":"2022-09-04","objectID":"/3.-runtime%E4%B9%8Blockrank%E9%94%81%E6%8E%92%E5%90%8D%E6%9C%BA%E5%88%B6/:7:0","tags":["runtime","goåº•å±‚å®ç°"],"title":"3. runtimeä¹‹lockRanké”æ’åæœºåˆ¶","uri":"/3.-runtime%E4%B9%8Blockrank%E9%94%81%E6%8E%92%E5%90%8D%E6%9C%BA%E5%88%B6/"},{"categories":["go runtime"],"content":"åˆ¤æ–­gæ˜¯å¦æŒæœ‰é”l // åˆ¤æ–­mæœ‰æ²¡æœ‰æŒæœ‰é”l func checkLockHeld(gp *g, l *mutex) bool { for i := gp.m.locksHeldLen - 1; i \u003e= 0; i-- { if gp.m.locksHeld[i].lockAddr == uintptr(unsafe.Pointer(l)) { return true } } return false } func assertLockHeld(l *mutex)çœç•¥äº†ä¸€ä¸ªgå‚æ•°ï¼Œè¿™ä¸ªé‡Œé¢æ˜¯è·å–å½“å‰æ‰§è¡Œçš„gçš„m func assertRankHeld(r lockRank)è¿™ä¸ªå’Œä¸Šé¢çš„é€»è¾‘å·®ä¸å¤šï¼Œä½ ä»¬ä¸‹å»è‡ªå·±çœ‹ï¼Œå°±æ˜¯åˆ¤æ–­mæ˜¯å¦æŒæœ‰è¿™ä¸ªæ’å ","date":"2022-09-04","objectID":"/3.-runtime%E4%B9%8Blockrank%E9%94%81%E6%8E%92%E5%90%8D%E6%9C%BA%E5%88%B6/:8:0","tags":["runtime","goåº•å±‚å®ç°"],"title":"3. runtimeä¹‹lockRanké”æ’åæœºåˆ¶","uri":"/3.-runtime%E4%B9%8Blockrank%E9%94%81%E6%8E%92%E5%90%8D%E6%9C%BA%E5%88%B6/"},{"categories":["go runtime"],"content":"å‡å¦‚æˆ‘ä»¬å»é¤é¦†åƒé¥­ï¼Œä¸‹å•åä¼šç»™ä½ ä¸€ä¸ªç¼–å·ï¼Œç„¶åä½ ç­‰ç€å«å·æ‹¿èœå°±å¥½äº†ã€‚ æˆ‘ä»¬å»ä¸‹å•äº†ï¼ŒæŠŠæˆ‘ä»¬å°±è®°å½•åˆ°ç³»ç»Ÿé‡Œé¢äº†wait+1 å«å·Signalï¼Œä»–ä¼šæŒ‰ç…§notifyåºå·æ¥å«å·ï¼Œå¦‚æœå«åˆ°ä½ äº†ï¼Œä½ å°±å¯ä»¥æ¥æ‹¿é¤äº†ï¼Œç„¶åå®ƒè¿˜ä¼šæŠŠnotifyåºå·åŠ ä¸€ å…¨éƒ¨éƒ½åšå¥½äº†Broadcastï¼ŒæŠŠæ‰€æœ‰äººéƒ½å«è¿‡æ¥æ‹¿é¤ï¼ŒæŠŠnotifyåºå·æ›´æ–°æˆæœ€å¤§çš„å‡ºå•å· headå°±æ˜¯æŒ‡å‘æˆ‘ä»¬æ’é˜Ÿçš„ç¬¬ä¸€ä¸ªäºº(sudog) tailå°±æ˜¯æˆ‘ä»¬é˜Ÿä¼çš„æœ€åä¸€ä¸ªäºº(sudog) æ’é˜Ÿæ˜¯é€šè¿‡sudog.nextè¿›è¡Œè¿æ¥çš„ ","date":"2022-09-03","objectID":"/2.-runtime%E4%B9%8Bnotifylist%E6%9D%A1%E4%BB%B6%E5%94%A4%E9%86%92/:0:0","tags":["runtime","goåº•å±‚å®ç°"],"title":"2. runtimeä¹‹notifyListæ¡ä»¶å”¤é†’","uri":"/2.-runtime%E4%B9%8Bnotifylist%E6%9D%A1%E4%BB%B6%E5%94%A4%E9%86%92/"},{"categories":["go runtime"],"content":"ç»“æ„ type notifyList struct { wait uint32 notify uint32 lock mutex head *sudog tail *sudog } wait å½“å‰å‡ºå•æ—¶çš„åºå· notify å½“å‰æ­£åœ¨å‡ºé¤çš„åºå·ï¼Œé¤å‡ºå¥½åï¼Œä¼šæŒ‰ç…§è¿™ä¸ªåºå·å«å· lock é” head å½“å‰æ’é˜Ÿç­‰é¤äººçš„ç¬¬ä¸€ä¸ª tail å½“å‰æ’é˜Ÿç­‰é¤äººçš„æœ€åä¸€ä¸ª ","date":"2022-09-03","objectID":"/2.-runtime%E4%B9%8Bnotifylist%E6%9D%A1%E4%BB%B6%E5%94%A4%E9%86%92/:1:0","tags":["runtime","goåº•å±‚å®ç°"],"title":"2. runtimeä¹‹notifyListæ¡ä»¶å”¤é†’","uri":"/2.-runtime%E4%B9%8Bnotifylist%E6%9D%A1%E4%BB%B6%E5%94%A4%E9%86%92/"},{"categories":["go runtime"],"content":"è·å–å‡ºé¤å· func notifyListAdd(l *notifyList) uint32 { // ç»™waitåŠ ä¸Š1ï¼Œè¿”å›åŸæ¥waitçš„åºå·ï¼ŒwaitåŠ å®Œ1ä¹‹åå°±æ˜¯ä¸‹ä¸€æ¬¡ç‚¹å•è¦å‡ºçš„å· return atomic.Xadd(\u0026l.wait, 1) - 1 } ","date":"2022-09-03","objectID":"/2.-runtime%E4%B9%8Bnotifylist%E6%9D%A1%E4%BB%B6%E5%94%A4%E9%86%92/:2:0","tags":["runtime","goåº•å±‚å®ç°"],"title":"2. runtimeä¹‹notifyListæ¡ä»¶å”¤é†’","uri":"/2.-runtime%E4%B9%8Bnotifylist%E6%9D%A1%E4%BB%B6%E5%94%A4%E9%86%92/"},{"categories":["go runtime"],"content":"äººå»æ’é˜Ÿ func notifyListWait(l *notifyList, t uint32) { // åŠ é” lockWithRank(\u0026l.lock, lockRankNotifyList) // æˆ‘ä»¬æ‹¿ç€å•å·å»æ’é˜Ÿï¼Œå…ˆçœ‹ä¸€ä¸‹æˆ‘ä»¬çš„å•å·æ˜¯ä¸æ˜¯å«å·ç³»ç»Ÿå½“å‰åº”è¯¥å«çš„å·å°ï¼Œå¦‚æœå°çš„è¯ï¼Œè‚¯å®šå«ä¸åˆ°æˆ‘ä»¬ï¼Œæˆ‘ä»¬èµ°å°±å¥½äº† if less(t, l.notify) { unlock(\u0026l.lock) return } // æ–°å»ºä¸€ä¸ªsudog s := acquireSudog() // è·å–å½“å‰è¦é˜»å¡çš„g s.g = getg() // æŠŠæˆ‘ä»¬çš„tæ”¾åˆ°sudog s.ticket = t // å¦‚æœé˜Ÿä¼æ²¡æœ‰å°¾å·´ï¼Œé‚£æˆ‘ä»¬å°±æ˜¯ä¸€ä¸ª if l.tail == nil { // æ²¡æœ‰å°¾å·´ï¼Œä¹Ÿå°±æ˜¯æ²¡äººæ’é˜Ÿï¼Œæˆ‘å°±æ¥å½“å¤´ l.head = s } else { l.tail.next = s } // æ¯æ¬¡æ’é˜Ÿè‚¯å®šä¼šè®¾ç½®å°¾å·´çš„ l.tail = s // æ’å®Œé˜Ÿï¼Œæˆ‘ä»¬å°±ç­‰ç€å§ï¼Œå¯ä»¥ç«™åœ¨åŸåœ°ä¼‘æ¯ä¸€ä¼š goparkunlock(\u0026l.lock, waitReasonSyncCondWait, traceEvGoBlockCond, 3) // æ‰§è¡Œåˆ°è¿™é‡Œï¼Œå°±è¯æ˜ï¼Œå«åˆ°æˆ‘ä»¬äº† if t0 != 0 { blockevent(s.releasetime-t0, 2) } // é‡Šæ”¾sudog releaseSudog(s) } ","date":"2022-09-03","objectID":"/2.-runtime%E4%B9%8Bnotifylist%E6%9D%A1%E4%BB%B6%E5%94%A4%E9%86%92/:3:0","tags":["runtime","goåº•å±‚å®ç°"],"title":"2. runtimeä¹‹notifyListæ¡ä»¶å”¤é†’","uri":"/2.-runtime%E4%B9%8Bnotifylist%E6%9D%A1%E4%BB%B6%E5%94%A4%E9%86%92/"},{"categories":["go runtime"],"content":"å«å·ï¼Œå‡ºäº†ä¸€ä¸ªé¤äº† func notifyListNotifyOne(l *notifyList) { // åˆ¤æ–­æˆ‘ä»¬å½“å‰è¦å‡ºå•çš„å·ç ï¼Œå’Œæˆ‘ä»¬è½®åˆ°å«çš„å·ç æ˜¯ä¸æ˜¯æƒ³ç­‰çš„ï¼Œå¦‚æœæƒ³ç­‰ï¼Œé‚£å°±æ²¡äººæ’é˜Ÿï¼Œå°±æ²¡æœ‰å•å­åœ¨åš if atomic.Load(\u0026l.wait) == atomic.Load(\u0026l.notify) { return } // åŠ é” lockWithRank(\u0026l.lock, lockRankNotifyList) // tå°±æœ‰æˆ‘ä»¬éœ€è¦é€šçŸ¥åˆ°çš„åºå· t := l.notify // å¦‚æœtæ˜¯æˆ‘ä»¬å°†è¦å‡ºå•çš„åºå·çš„è¯ï¼Œé‚£ä¹ˆè‚¯å®šå°±æ²¡æœ‰gåœ¨ç­‰å¾…æˆ‘ä»¬å‡ºé¤ if t == atomic.Load(\u0026l.wait) { unlock(\u0026l.lock) return } // æ›´æ–°ä¸€ä¸‹notifyçš„åºå· atomic.Store(\u0026l.notify, t+1) // åœ¨é˜Ÿä¼é‡Œé¢æ‰¾åˆ°ç¬¬ä¸€ä¸ªäººï¼Œç„¶åç»™ä»–é€šçŸ¥è¯´å¯ä»¥äº† // å¹¶ä¸”ï¼Œè®©é˜Ÿä¼å¾€å‰èµ°ä¸€æ­¥ for p, s := (*sudog)(nil), l.head; s != nil; p, s = s, s.next { if s.ticket == t { // æ‰¾åˆ°æˆ‘ä»¬è¦é€šçŸ¥çš„sudogäº† n := s.next if p != nil { p.next = n } else { l.head = n } if n == nil { l.tail = p } unlock(\u0026l.lock) s.next = nil // é€šçŸ¥é¤å¥½äº†ï¼Œä½ å¯ä»¥æ¥æ‹¿é¤äº† readyWithTime(s, 4) return } } unlock(\u0026l.lock) } ","date":"2022-09-03","objectID":"/2.-runtime%E4%B9%8Bnotifylist%E6%9D%A1%E4%BB%B6%E5%94%A4%E9%86%92/:4:0","tags":["runtime","goåº•å±‚å®ç°"],"title":"2. runtimeä¹‹notifyListæ¡ä»¶å”¤é†’","uri":"/2.-runtime%E4%B9%8Bnotifylist%E6%9D%A1%E4%BB%B6%E5%94%A4%E9%86%92/"},{"categories":["go runtime"],"content":"å”¤é†’æ‰€æœ‰ func notifyListNotifyAll(l *notifyList) { if atomic.Load(\u0026l.wait) == atomic.Load(\u0026l.notify) { return } lockWithRank(\u0026l.lock, lockRankNotifyList) // æŠŠé˜Ÿä¼è®°è½½äº†ä¸´æ—¶çš„sé‡Œé¢ s := l.head // æŠŠé˜Ÿä¼æ¸…ç©ºäº† l.head = nil l.tail = nil // æ›´æ–°ä¸€ä¸‹å«å· atomic.Store(\u0026l.notify, atomic.Load(\u0026l.wait)) unlock(\u0026l.lock) // æŠŠé˜Ÿä¼é‡Œé¢æ‰€æœ‰äººéƒ½é€šçŸ¥ä¸€éï¼Œèœå¥½äº† for s != nil { next := s.next s.next = nil readyWithTime(s, 4) s = next } } ","date":"2022-09-03","objectID":"/2.-runtime%E4%B9%8Bnotifylist%E6%9D%A1%E4%BB%B6%E5%94%A4%E9%86%92/:5:0","tags":["runtime","goåº•å±‚å®ç°"],"title":"2. runtimeä¹‹notifyListæ¡ä»¶å”¤é†’","uri":"/2.-runtime%E4%B9%8Bnotifylist%E6%9D%A1%E4%BB%B6%E5%94%A4%E9%86%92/"},{"categories":["go runtime"],"content":"å‡å¦‚æˆ‘ä»¬æœ‰ä¸€ä¸ªå®°ğŸ·å‚semaï¼Œé‡Œé¢æœ‰å¾ˆå¤šçš„å±é™©å·¥å…·ï¼Œæ¯”å¦‚åˆ€ã€‚ æˆ‘ä»¬æœ‰å¥½å‡ ä¸ªä»“åº“ï¼ˆä¸åŒçš„addrï¼‰ï¼Œé‡Œé¢æ”¾ç€å„ç§å„æ ·çš„åˆ€ï¼Œæ¯ä¸ªä»“åº“å®ƒä»¬éƒ½è®°å½•ç€æœ‰å¤šå°‘æŠŠåˆ€addrå­˜å‚¨çš„uint32æ•°ã€‚ å®ƒä»¬å¯èƒ½å¥½å‡ ä¸ªä»“åº“é‡Œçš„æ¯”è¾ƒè¿‘ï¼Œä¼šæœ‰ä¸€ä¸ªå¤§é—¨ç»Ÿä¸€æ’é˜Ÿç®¡ç†ï¼ˆå®ƒä»¬ä¼šé€‰æ‹©åˆ°åŒä¸€ä¸ªseamRootï¼‰ã€‚ è¿™ä¸ªå¤§é—¨ä¸Šé¢è®°å½•äº†å½“å‰æœ‰å¤šå°‘äººåœ¨æ’é˜Ÿnwaitï¼Œè®°å½•äº†æ’é˜Ÿæƒ…å†µtreap å¤§é—¨å¤–é¢è¦è®©å»ä¸åŒçš„ä»“åº“çš„äººæ’ç€ä¸åŒçš„é˜Ÿä¼ï¼Œè¿™äº›é˜Ÿä¼çš„å¤´éƒ¨é€šè¿‡parentã€nextã€prevç»„æˆäº†ä¸€ä¸ªå¹³è¡¡äºŒå‰æ ‘ é˜Ÿä¼é‡Œé¢æ‰€æœ‰äººå°±æ˜¯ä¸€ä¸ªé“¾è¡¨ï¼Œé€šè¿‡waitlinkè¿›è¡Œè¿æ¥ï¼Œæ¯ä¸ªäººçš„waittailè®°å½•ç€å®ƒä»¬é˜Ÿä¼çš„æœ€åä¸€ä¸ªäºº å¤§é—¨çš„treapä¸Šé¢åªè®°å½•äº†æ¯ä¸ªé˜Ÿä¼çš„ç¬¬ä¸€ä¸ªäºº ","date":"2022-09-03","objectID":"/1.-runtime%E4%B9%8Bsema%E4%BF%A1%E5%8F%B7%E9%94%81/:0:0","tags":["runtime","goåº•å±‚å®ç°"],"title":"1. runtimeä¹‹semaä¿¡å·é”","uri":"/1.-runtime%E4%B9%8Bsema%E4%BF%A1%E5%8F%B7%E9%94%81/"},{"categories":["go runtime"],"content":"è·å–é—¨é”æ—¶ä¼ é€’çš„uint32åœ°å€æœ‰ä»€ä¹ˆç”¨ æˆ‘ä»¬åœ¨è·å–å’Œå½’è¿˜åˆ€çš„æ—¶å€™ï¼Œéƒ½éœ€è¦ä»ä¸€ä¸ªuint32çš„åœ°å€ä¸Šè¿›è¡Œå¯»æ‰¾é”ï¼Œè¿™ä¸ªuint32æ•°å€¼ä»£è¡¨ç€å½“å‰ä»“åº“é‡Œé¢çš„åˆ€çš„æ•°é‡ï¼Œuint32çš„åœ°å€å°±æ˜¯ä»“åº“åœ°å€ã€‚ ","date":"2022-09-03","objectID":"/1.-runtime%E4%B9%8Bsema%E4%BF%A1%E5%8F%B7%E9%94%81/:1:0","tags":["runtime","goåº•å±‚å®ç°"],"title":"1. runtimeä¹‹semaä¿¡å·é”","uri":"/1.-runtime%E4%B9%8Bsema%E4%BF%A1%E5%8F%B7%E9%94%81/"},{"categories":["go runtime"],"content":"æˆ‘ä»¬é€šè¿‡ä»“åº“åœ°å€æ‰¾å¤§é—¨ // æˆ‘ä»¬è§„åˆ’äº†251ä¸ªå¤§é—¨ï¼Œä»semtable0ï½250ä¸‹æ ‡ const semTabSize = 251 // semtableé•¿åº¦ // æ¯ä¸ªsemtableï¼Œé‡Œé¢å°±æ˜¯ä¸€ä¸ªå¤§é—¨ var semtable [semTabSize]struct { // semaRootå°±æ˜¯å¤§é—¨ root semaRoot pad [cpu.CacheLinePadSize - unsafe.Sizeof(semaRoot{})]byte } // ä¸‹é¢å°±æ˜¯æ ¹æ®æˆ‘ä»¬ä¼ è¿›æ¥çš„åœ°å€æ‰¾å¤§é—¨çš„ä¸€ä¸ªæ–¹æ³• func semroot(addr *uint32) *semaRoot { return \u0026semtable[(uintptr(unsafe.Pointer(addr))\u003e\u003e3)%semTabSize].root } ","date":"2022-09-03","objectID":"/1.-runtime%E4%B9%8Bsema%E4%BF%A1%E5%8F%B7%E9%94%81/:2:0","tags":["runtime","goåº•å±‚å®ç°"],"title":"1. runtimeä¹‹semaä¿¡å·é”","uri":"/1.-runtime%E4%B9%8Bsema%E4%BF%A1%E5%8F%B7%E9%94%81/"},{"categories":["go runtime"],"content":"ä»“åº“å¤§é—¨é•¿å•¥æ · // semaRoot å°±æ˜¯ä»“åº“å¤§é—¨ï¼Œé‡Œé¢è®°å½•ç€é—¨å£ç­‰äº†å¤šå°‘äººï¼Œæ’é˜Ÿçš„é˜Ÿä¼ï¼Œä»¥åŠé˜Ÿä¼é‡Œé¢çš„äººæ˜¯è¦å»å“ªä¸ªå°ä»“åº“ type semaRoot struct { lock mutex treap *sudog // å¤§é—¨è¿›å»ä¼šæœ‰å¾ˆå¤šå°ä»“åº“ï¼Œä¸åŒä»“åº“æ’é˜Ÿé˜Ÿä¼çš„ç¬¬ä¸€ä¸ªäºº nwait uint32 // ç­‰å¾…çš„äººçš„æ•°é‡ } ","date":"2022-09-03","objectID":"/1.-runtime%E4%B9%8Bsema%E4%BF%A1%E5%8F%B7%E9%94%81/:3:0","tags":["runtime","goåº•å±‚å®ç°"],"title":"1. runtimeä¹‹semaä¿¡å·é”","uri":"/1.-runtime%E4%B9%8Bsema%E4%BF%A1%E5%8F%B7%E9%94%81/"},{"categories":["go runtime"],"content":"ç®€å•çš„æ‹¿ä¸€ä¸ªåˆ€ // æˆ‘ä»¬è·å–åˆ€çš„æ—¶å€™ï¼Œå¦‚æœä»“åº“é‡Œé¢è¿˜æœ‰ï¼Œé‚£å°±ç›´æ¥æ‹¿èµ°ï¼Œå¹¶è¿”å›trueï¼Œä¸ç„¶å°±è¿”å›false func cansemacquire(addr *uint32) bool { for { v := atomic.Load(addr) if v == 0 { return false } if atomic.Cas(addr, v, v-1) { return true } } } ","date":"2022-09-03","objectID":"/1.-runtime%E4%B9%8Bsema%E4%BF%A1%E5%8F%B7%E9%94%81/:4:0","tags":["runtime","goåº•å±‚å®ç°"],"title":"1. runtimeä¹‹semaä¿¡å·é”","uri":"/1.-runtime%E4%B9%8Bsema%E4%BF%A1%E5%8F%B7%E9%94%81/"},{"categories":["go runtime"],"content":"è¦å»æ‹¿ä¸€ä¸ªåˆ€ // è¿™ä¸ªæ˜¯è·å–åˆ€çš„çœŸå®çš„é€»è¾‘ func semacquire1(addr *uint32, lifo bool, profile semaProfileFlags, skipframes int) { // æ˜¯è°æ¥è·å–ï¼Œæ˜¯gp gp := getg() if gp != gp.m.curg { throw(\"semacquire not on the G stack\") } // ç®€å•çš„caseï¼Œå°±æ˜¯ä»“åº“é‡Œé¢è¿˜æœ‰åˆ€ if cansemacquire(addr) { return } // ä¸‹é¢å°±æ˜¯è¿™4æ­¥ // 1. å¢åŠ å¤§é—¨å£ç­‰å¾…æ’é˜Ÿçš„æ•°é‡ // 2. å°è¯•å†å»çœ‹ä¸€ä¸‹æˆ‘ä»¬çš„ä»“åº“é‡Œé¢è¿˜æœ‰æ²¡æœ‰åˆ€ï¼Œå¦‚æœæœ‰ï¼Œå¯èƒ½æ˜¯æœ‰äººå½’è¿˜äº†ï¼Œæˆ‘ä»¬å°±ç›´æ¥æ‹¿ç€èµ° // 3. å»æ’é˜Ÿäº† // 4. ä¼‘çœ  // æ–°å»ºä¸€ä¸ªsudog s := acquireSudog() // è·å–å¤§é—¨ä¿¡æ¯ root := semroot(addr) t0 := int64(0) s.releasetime = 0 s.acquiretime = 0 // sçš„ticketæ˜¯0 s.ticket = 0 for { // å¤§é—¨åŠ é” lockWithRank(\u0026root.lock, lockRankRoot) // ç»™å¤§é—¨ç­‰å¾…äººæ•°é‡ä¸ŠåŠ 1 atomic.Xadd(\u0026root.nwait, 1) // åˆ¤æ–­ä»–è¦å»çš„ä»“åº“é‡Œé¢è¿˜æœ‰æ²¡æœ‰åˆ€ if cansemacquire(addr) { atomic.Xadd(\u0026root.nwait, -1) unlock(\u0026root.lock) break } // æš‚æ—¶é‡Œé¢æ²¡æœ‰ä¸œè¥¿ï¼Œæˆ‘ä»¬ç­‰ç€å§ï¼Œå°±è¦å»æ’é˜Ÿ root.queue(addr, s, lifo) // goparké˜»å¡è¿™ä¸ªg goparkunlock(\u0026root.lock, waitReasonSemacquire, traceEvGoBlockSync, 4+skipframes) // è¿™è¾¹æ˜¯å”¤é†’äº†è¿™ä¸ªg // æˆ‘ä»¬çš„ç¥¨æ®ä¸æ˜¯0çš„è¯ï¼Œæˆ–è€…æˆ‘ä»¬ä»“åº“é‡Œé¢æœ‰åˆ€çš„è¯ï¼Œå°±å¯ä»¥å¾—åˆ°æ‰§è¡Œ if s.ticket != 0 || cansemacquire(addr) { break } } // é‡Šæ”¾sudog releaseSudog(s) } ","date":"2022-09-03","objectID":"/1.-runtime%E4%B9%8Bsema%E4%BF%A1%E5%8F%B7%E9%94%81/:5:0","tags":["runtime","goåº•å±‚å®ç°"],"title":"1. runtimeä¹‹semaä¿¡å·é”","uri":"/1.-runtime%E4%B9%8Bsema%E4%BF%A1%E5%8F%B7%E9%94%81/"},{"categories":["go runtime"],"content":"åˆ€æ²¡ç›´æ¥æ‹¿åˆ°ï¼Œè¦å»æ’é˜Ÿç­‰ // è¿™ä¸ªå°±æ˜¯ç»™semaRoot.treapä¸Šé¢è¿›è¡Œæ’é˜Ÿ func (root *semaRoot) queue(addr *uint32, s *sudog, lifo bool) { // æ‹¿åˆ°æˆ‘ä»¬è¦æ’é˜Ÿçš„äºº s.g = getg() // å­˜ä¸€ä¸‹å®ƒè¦å»çš„ä»“åº“åœ¨å“ª s.elem = unsafe.Pointer(addr) // ç­‰æˆ‘ä»¬ä¸‹é¢å†ç»™ä»–è¯´ï¼Œå®ƒè¯¥æ‹åˆ°å“ªé‡Œï¼Œå‰ä¸€ä¸ªé˜Ÿä¼æ˜¯è°ï¼Œåä¸€ä¸ªé˜Ÿä¼æ˜¯è° s.next = nil s.prev = nil var last *sudog // ptä¸€å¼€å§‹å°±æ˜¯ç¬¬ä¸€ä¸ªé˜Ÿä¼ç¬¬ä¸€ä¸ªäºº pt := \u0026root.treap // forå¾ªç¯ï¼Œåœ¨æ¯ä¸ªé˜Ÿåˆ—é‡Œé¢æ‰¾æˆ‘ä»¬çš„å°ä»“åº“æ˜¯é‚£ä¸ªé˜Ÿä¼ for t := *pt; t != nil; t = *pt { if t.elem == unsafe.Pointer(addr) { // tå°±æ˜¯æˆ‘ä»¬å°ä»“åº“çš„æ’é˜Ÿä¿¡æ¯ if lifo { // lifoæ˜¯è¯´ï¼Œåå…¥é˜Ÿçš„ï¼Œå…ˆæ‰§è¡Œï¼Œæ’åˆ°æœ€å‰é¢ // prevå’Œnextéƒ½æ˜¯é˜Ÿä¼ç¬¬ä¸€ä¸ªäººè¦çŸ¥é“çš„ // åŒä¸€ä¸ªé˜Ÿä¼çš„ä¸åŒäººæ˜¯é€šè¿‡waitlinkè¿æ¥çš„ // é˜Ÿä¼çš„æ¯ä¸ªäººéƒ½èƒ½é€šè¿‡waittailçŸ¥é“æœ€åä¸€ä¸ªäººçš„ä¿¡æ¯ *pt = s s.ticket = t.ticket s.acquiretime = t.acquiretime s.parent = t.parent s.prev = t.prev s.next = t.next if s.prev != nil { s.prev.parent = s } if s.next != nil { s.next.parent = s } // Add t first in s's wait list. s.waitlink = t s.waittail = t.waittail if s.waittail == nil { s.waittail = t } t.parent = nil t.prev = nil t.next = nil t.waittail = nil } else { // æŠŠäººæ’é˜Ÿé˜Ÿä¼çš„æœ€åé¢ if t.waittail == nil { t.waitlink = s } else { t.waittail.waitlink = s } t.waittail = s s.waitlink = nil } return } // å€’æ˜¯ç¬¬äºŒä¸ªæ‰¾åˆ°çš„é˜Ÿä¼ last = t // å› ä¸ºæˆ‘ä»¬å­˜å‚¨çš„æ—¶å€™æ˜¯è¿™æ ·å­˜çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿™è¾¹ä¹Ÿæ˜¯è¿™æ ·æ‰¾çš„ if uintptr(unsafe.Pointer(addr)) \u003c uintptr(t.elem) { pt = \u0026t.prev } else { pt = \u0026t.next } } // ticketå¾ˆç»å¸¸å’Œ0è¿›è¡Œæ¯”å¯¹ï¼Œæ‰€ä»¥æˆ‘ä»¬è®©æœ€å1ä½ä¸º1çš„è¯ï¼Œè‚¯å®šå°±ä¸æ˜¯0 s.ticket = fastrand() | 1 s.parent = last *pt = s // ä¿®å¤è¿™ä¸ªå¹³è¡¡äºŒå‰æ ‘ï¼Œè®©è¿™ä¸ªæ ‘ç»§ç»­æ»¡è¶³æ¡ä»¶ for s.parent != nil \u0026\u0026 s.parent.ticket \u003e s.ticket { if s.parent.prev == s { root.rotateRight(s.parent) } else { if s.parent.next != s { panic(\"semaRoot queue\") } root.rotateLeft(s.parent) } } } ","date":"2022-09-03","objectID":"/1.-runtime%E4%B9%8Bsema%E4%BF%A1%E5%8F%B7%E9%94%81/:6:0","tags":["runtime","goåº•å±‚å®ç°"],"title":"1. runtimeä¹‹semaä¿¡å·é”","uri":"/1.-runtime%E4%B9%8Bsema%E4%BF%A1%E5%8F%B7%E9%94%81/"},{"categories":["go runtime"],"content":"å½’è¿˜ä¸€ä¸ªåˆ€ï¼Œè®©å…¶ä»–çš„äººä¹Ÿèƒ½å»ç”¨äº† // å½’è¿˜ä¸€ä¸ªåˆ€ func semrelease1(addr *uint32, handoff bool, skipframes int) { // æ‰¾åˆ°å¤§é—¨ root := semroot(addr) // ç»™ä»“åº“é‡Œé¢è¿˜ä¸€æŠŠåˆ€ atomic.Xadd(addr, 1) // å¦‚æœæ²¡æœ‰äººåœ¨ç­‰ï¼Œå°±ç›´æ¥ç»“æŸå°±å¥½äº† if atomic.Load(\u0026root.nwait) == 0 { return } // æœ‰äººåœ¨ç­‰å‘¢ // åŠ é” lockWithRank(\u0026root.lock, lockRankRoot) // åœ¨åˆ¤æ–­ä¸€ä¸‹ï¼Œå¯èƒ½æœ‰å…¶ä»–äººè¿‡æ¥äº† if atomic.Load(\u0026root.nwait) == 0 { unlock(\u0026root.lock) return } // æˆ‘ä»¬æ‰¾ä¸€ä¸ªsudogè®©ä»–å‡ºæ¥æ‹¿åˆ€å·¥ä½œ s, t0 := root.dequeue(addr) // å¦‚æœæ‰¾åˆ°äº†ï¼Œå°±è®©å¤§é—¨çš„ç­‰å¾…æ•°é‡-1 if s != nil { atomic.Xadd(\u0026root.nwait, -1) } // è§£é”å¤§é—¨ unlock(\u0026root.lock) if s != nil { // s.ticket != 0 è¯æ˜è¿™ä¸ªticketä¸å¤ªåˆæ³• // ä¹Ÿå°±æ˜¯è¯´sudogè¦æ‰§è¡Œï¼Œå¿…é¡»è¦æŠŠç¥¨æ¸…ç©º if s.ticket != 0 { throw(\"corrupted semaphore ticket\") } // æˆ‘ä»¬å†å»åˆ¤æ–­ä¸€ä¸‹èƒ½ä¸èƒ½æ‹¿åˆ°åˆ€ï¼Œèƒ½æ‹¿åˆ°çš„è¯ï¼Œticket=1 if handoff \u0026\u0026 cansemacquire(addr) { s.ticket = 1 } // æ¢å¤æˆ‘ä»¬çš„gï¼Œå°†æˆ‘ä»¬çš„gæ”¾åœ¨pçš„runnext readyWithTime(s, 5+skipframes) // å¦‚æœticketæ˜¯1ï¼Œæˆ‘ä»¬çš„gçš„mä¸Šæ²¡ä¸Šé”çš„è¯ if s.ticket == 1 \u0026\u0026 getg().m.locks == 0 { // å¦‚æœæ˜¯é¥¥é¥¿æ¨¡å¼ï¼Œæˆ‘ä»¬ç›´æ¥åˆ‡æ¢åˆ°gæ‰§è¡Œï¼Œä¸è¦ç­‰äº† goyield() } } } ","date":"2022-09-03","objectID":"/1.-runtime%E4%B9%8Bsema%E4%BF%A1%E5%8F%B7%E9%94%81/:7:0","tags":["runtime","goåº•å±‚å®ç°"],"title":"1. runtimeä¹‹semaä¿¡å·é”","uri":"/1.-runtime%E4%B9%8Bsema%E4%BF%A1%E5%8F%B7%E9%94%81/"},{"categories":["go runtime"],"content":"å…¶ä»–äººè¿˜åˆ€ï¼Œé€šçŸ¥æˆ‘ä»¬æ¥æ‹¿åˆ€ func (root *semaRoot) dequeue(addr *uint32) (found *sudog, now int64) { // pså°±æ˜¯é—¨é”çš„ç¬¬ä¸€ä¸ªé˜Ÿä¼çš„ç¬¬ä¸€ä¸ªäºº ps := \u0026root.treap s := *ps for ; s != nil; s = *ps { if s.elem == unsafe.Pointer(addr) { // æ‰¾åˆ°æˆ‘ä»¬çš„é˜Ÿä¼äº† goto Found } if uintptr(unsafe.Pointer(addr)) \u003c uintptr(s.elem) { ps = \u0026s.prev } else { ps = \u0026s.next } } // æ²¡æ‰¾åˆ°æˆ‘ä»¬çš„é˜Ÿä¼ return nil, 0 Found: // åˆ é™¤æˆ‘ä»¬çš„sudog if t := s.waitlink; t != nil { *ps = t t.ticket = s.ticket t.parent = s.parent t.prev = s.prev if t.prev != nil { t.prev.parent = t } t.next = s.next if t.next != nil { t.next.parent = t } if t.waitlink != nil { t.waittail = s.waittail } else { t.waittail = nil } t.acquiretime = now s.waitlink = nil s.waittail = nil } else { // åˆ é™¤è¿™ä¸ªé˜Ÿä¼ï¼Œå› ä¸ºæ²¡æœ‰äººæ’é˜Ÿäº†ï¼Œè¿˜è¦ä¿®å¤ä¸€ä¸‹å¹³è¡¡äºŒå‰æ ‘ for s.next != nil || s.prev != nil { if s.next == nil || s.prev != nil \u0026\u0026 s.prev.ticket \u003c s.next.ticket { root.rotateRight(s) } else { root.rotateLeft(s) } } // Remove s, now a leaf. if s.parent != nil { if s.parent.prev == s { s.parent.prev = nil } else { s.parent.next = nil } } else { root.treap = nil } } s.parent = nil s.elem = nil s.next = nil s.prev = nil s.ticket = 0 return s, now } ","date":"2022-09-03","objectID":"/1.-runtime%E4%B9%8Bsema%E4%BF%A1%E5%8F%B7%E9%94%81/:8:0","tags":["runtime","goåº•å±‚å®ç°"],"title":"1. runtimeä¹‹semaä¿¡å·é”","uri":"/1.-runtime%E4%B9%8Bsema%E4%BF%A1%E5%8F%B7%E9%94%81/"}]