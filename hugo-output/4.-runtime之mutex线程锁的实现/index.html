<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>4. runtimeä¹‹mutexçº¿ç¨‹é”çš„å®ç° - ğŸ  Xsc Study Notes</title><meta name=Description content="ä¸ºäº†æ›´å¥½çš„å­¦ä¹ æ€»ç»“å›é¡¾ï¼Œå»ºç«‹äº†è¿™ä¸ªblogï¼Œè¿™é‡Œæ˜¯æˆ‘çš„å­¦ä¹ ç¬”è®°ã€‚"><meta property="og:title" content="4. runtimeä¹‹mutexçº¿ç¨‹é”çš„å®ç°"><meta property="og:description" content="sync.Mutex å’Œ sync.Cond éƒ½æ˜¯å¯¹äºåç¨‹ g æ¥è¯´çš„ï¼Œè€Œ m.mOS.mutex å’Œ m.mOS.cond æ˜¯å¯¹çº¿ç¨‹ m æ¥è¯´çš„ï¼Œåº•å±‚ç”¨æ³•å¤§æ¦‚ç›¸åŒã€‚ runtime.mutex åœ¨ sema çš„å®ç°æ–¹æ¡ˆä¸‹ï¼ˆä¸åŒç³»ç»Ÿå†³å®šç€å®ç°æ–¹æ¡ˆçš„ä¸åŒï¼‰ï¼Œåº•å±‚ä¾èµ– m.mOS.mutex å’Œ m.mOS.cond æ¥"><meta property="og:type" content="article"><meta property="og:url" content="https://xsc.scccc.cn/4.-runtime%E4%B9%8Bmutex%E7%BA%BF%E7%A8%8B%E9%94%81%E7%9A%84%E5%AE%9E%E7%8E%B0/"><meta property="article:published_time" content="2022-09-04T01:39:00+08:00"><meta property="article:modified_time" content="2022-09-04T01:39:00+08:00"><meta property="og:site_name" content="ğŸ  Xsc Study Notes"><meta name=twitter:card content="summary"><meta name=twitter:title content="4. runtimeä¹‹mutexçº¿ç¨‹é”çš„å®ç°"><meta name=twitter:description content="sync.Mutex å’Œ sync.Cond éƒ½æ˜¯å¯¹äºåç¨‹ g æ¥è¯´çš„ï¼Œè€Œ m.mOS.mutex å’Œ m.mOS.cond æ˜¯å¯¹çº¿ç¨‹ m æ¥è¯´çš„ï¼Œåº•å±‚ç”¨æ³•å¤§æ¦‚ç›¸åŒã€‚ runtime.mutex åœ¨ sema çš„å®ç°æ–¹æ¡ˆä¸‹ï¼ˆä¸åŒç³»ç»Ÿå†³å®šç€å®ç°æ–¹æ¡ˆçš„ä¸åŒï¼‰ï¼Œåº•å±‚ä¾èµ– m.mOS.mutex å’Œ m.mOS.cond æ¥"><meta name=application-name content="ğŸ  Xsc Study Notes"><meta name=apple-mobile-web-app-title content="ğŸ  Xsc Study Notes"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://xsc.scccc.cn/4.-runtime%E4%B9%8Bmutex%E7%BA%BF%E7%A8%8B%E9%94%81%E7%9A%84%E5%AE%9E%E7%8E%B0/><link rel=prev href=https://xsc.scccc.cn/3.-runtime%E4%B9%8Blockrank%E9%94%81%E6%8E%92%E5%90%8D%E6%9C%BA%E5%88%B6/><link rel=next href=https://xsc.scccc.cn/5.-runtime%E4%B9%8Bnote%E4%B8%80%E6%AC%A1%E6%80%A7%E9%80%9A%E7%9F%A5%E4%BA%8B%E4%BB%B6-copy/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css as=style onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css></noscript><link rel=preload href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css as=style onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"4. runtimeä¹‹mutexçº¿ç¨‹é”çš„å®ç°","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/xsc.scccc.cn\/4.-runtime%E4%B9%8Bmutex%E7%BA%BF%E7%A8%8B%E9%94%81%E7%9A%84%E5%AE%9E%E7%8E%B0\/"},"genre":"posts","keywords":"runtime, goåº•å±‚å®ç°","wordcount":3562,"url":"https:\/\/xsc.scccc.cn\/4.-runtime%E4%B9%8Bmutex%E7%BA%BF%E7%A8%8B%E9%94%81%E7%9A%84%E5%AE%9E%E7%8E%B0\/","datePublished":"2022-09-04T01:39:00+08:00","dateModified":"2022-09-04T01:39:00+08:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"Xsc"},"description":""}</script></head><body data-header-desktop=auto data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem('theme')?localStorage.getItem('theme')==='dark':('auto'==='auto'?window.matchMedia('(prefers-color-scheme: dark)').matches:'auto'==='dark'))&&document.body.setAttribute('theme','dark');</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="ğŸ  Xsc Study Notes"><span class=header-title-pre>ğŸ  </span><span id=id-1 class=typeit></span></a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>æ‰€æœ‰æ–‡ç«  </a><a class=menu-item href=/categories/>åˆ†ç±» </a><a class=menu-item href=/tags/>æ ‡ç­¾ </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop><input type=text placeholder=æƒ³æ‰¾ä»€ä¹ˆå°±æ¥æ‰¾å§ id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=æœç´¢><i class="fas fa-search fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=æ¸…ç©º><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a><span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></span><a href=javascript:void(0); class="menu-item theme-switch" title=åˆ‡æ¢ä¸»é¢˜><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="ğŸ  Xsc Study Notes"><span class=header-title-pre>ğŸ  </span><span id=id-2 class=typeit></span></a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=æƒ³æ‰¾ä»€ä¹ˆå°±æ¥æ‰¾å§ id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=æœç´¢><i class="fas fa-search fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=æ¸…ç©º><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a><span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>å–æ¶ˆ</a></div><a class=menu-item href=/posts/>æ‰€æœ‰æ–‡ç« </a><a class=menu-item href=/categories/>åˆ†ç±»</a><a class=menu-item href=/tags/>æ ‡ç­¾</a><a href=javascript:void(0); class="menu-item theme-switch" title=åˆ‡æ¢ä¸»é¢˜>
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>ç›®å½•</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">4. runtimeä¹‹mutexçº¿ç¨‹é”çš„å®ç°</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=https://xsc.scccc.cn title=Author target=_blank rel="noopener noreffer author" class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>Xsc</a></span>&nbsp;<span class=post-category>æ”¶å½•äº <a href=/categories/go-runtime/><i class="far fa-folder fa-fw" aria-hidden=true></i>go runtime</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2022-09-04>2022-09-04</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;çº¦ 3562 å­—&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;é¢„è®¡é˜…è¯» 8 åˆ†é’Ÿ&nbsp;</div></div><div class="details toc" id=toc-static data-kept=true><div class="details-summary toc-title"><span>ç›®å½•</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#mutexåŸºäºä¿¡å·semaçš„å®ç°>mutexåŸºäºä¿¡å·semaçš„å®ç°</a><ul><li><a href=#ä¿¡å·çš„å®ç°>ä¿¡å·çš„å®ç°</a><ul><li><a href=#æŒæœ‰ç»“æ„>æŒæœ‰ç»“æ„</a></li><li><a href=#semacreate>semacreate</a></li><li><a href=#semasleep>semasleep</a></li><li><a href=#semawakeup>semawakeup</a></li></ul></li><li><a href=#mutex-çš„åŠ è§£é”æ“ä½œ>mutex çš„åŠ è§£é”æ“ä½œ</a><ul><li><a href=#è·å–é”-lock>è·å–é” lock</a><ul><li><a href=#å½“ä¸€ä¸ªçº¿ç¨‹éœ€è¦è·å–ä¸€ä¸ªé”çš„æ—¶å€™ä»–æ‰§è¡Œæµç¨‹å¦‚ä¸‹>å½“ä¸€ä¸ªçº¿ç¨‹éœ€è¦è·å–ä¸€ä¸ªé”çš„æ—¶å€™ï¼Œä»–æ‰§è¡Œæµç¨‹å¦‚ä¸‹</a></li><li><a href=#ä¸ºä»€ä¹ˆmè¦é€šè¿‡é‚£ç§æ–¹å¼è®¾ç½®æˆ‘ä»¬ä¸¾ä¸ªä¾‹å­ä»–è¿™ä¸ªç®—æ³•å¾ˆå·§å¦™>ä¸ºä»€ä¹ˆmè¦é€šè¿‡é‚£ç§æ–¹å¼è®¾ç½®ï¼Œæˆ‘ä»¬ä¸¾ä¸ªä¾‹å­ï¼Œä»–è¿™ä¸ªç®—æ³•å¾ˆå·§å¦™ã€‚</a></li></ul></li><li><a href=#é‡Šæ”¾é”>é‡Šæ”¾é”</a></li></ul></li></ul></li><li><a href=#mutexåŸºäºfutexçš„å®ç°>mutexåŸºäºfutexçš„å®ç°</a><ul><li><a href=#è·å–é”>è·å–é”</a></li><li><a href=#é‡Šæ”¾é”-1>é‡Šæ”¾é”</a></li></ul></li></ul></nav></div></div><div class=content id=content><p><code>sync.Mutex</code> å’Œ <code>sync.Cond</code> éƒ½æ˜¯å¯¹äºåç¨‹ <code>g</code> æ¥è¯´çš„ï¼Œè€Œ <code>m.mOS.mutex</code> å’Œ <code>m.mOS.cond</code> æ˜¯å¯¹çº¿ç¨‹ <code>m</code> æ¥è¯´çš„ï¼Œåº•å±‚ç”¨æ³•å¤§æ¦‚ç›¸åŒã€‚</p><p><code>runtime.mutex</code> åœ¨ <code>sema</code> çš„å®ç°æ–¹æ¡ˆä¸‹ï¼ˆä¸åŒç³»ç»Ÿå†³å®šç€å®ç°æ–¹æ¡ˆçš„ä¸åŒï¼‰ï¼Œåº•å±‚ä¾èµ– <code>m.mOS.mutex</code> å’Œ <code>m.mOS.cond</code> æ¥åŠ è§£é”æ“æ§ <code>m</code> ï¼Œè¿™æ—¶å€™ <code>mutex</code> ä¸­çš„ <code>key</code> æ˜¯ <code>waitm</code> ï¼Œä¸€ä¸ªç­‰å¾…çš„ <code>m</code> çš„åœ°å€ã€‚</p><p><code>runtime.mutex</code> åœ¨ <code>futex</code> çš„å®ç°æ–¹æ¡ˆä¸‹ï¼Œ<code>key</code> å­˜å‚¨ç€é”çš„çŠ¶æ€</p><h2 id=mutexåŸºäºä¿¡å·semaçš„å®ç°>mutexåŸºäºä¿¡å·semaçš„å®ç°</h2><h3 id=ä¿¡å·çš„å®ç°>ä¿¡å·çš„å®ç°</h3><ul><li><code>func semacreate(mp *m)</code> ä¸º <code>m</code> åˆ›å»ºä¿¡å·é‡ï¼Œå¦‚æœå®ƒè¿˜æ²¡æœ‰çš„è¯ã€‚</li><li><code>func semasleep(ns int64) int32</code> æœ€é•¿é˜»å¡nsçº³ç§’æ¥å¾—åˆ°ä¸€ä¸ªä¿¡å·é‡ï¼ŒæˆåŠŸè¿”å›0ï¼Œå¤±è´¥è¿”å›-1</li><li><code>func semawakeup(mp *m)</code> æ¿€æ´»ä¸€ä¸ªä¿¡å·é‡</li></ul><p>æˆ‘ä»¬ä½¿ç”¨ <code>semacreate</code> åˆ›å»ºä¿¡å·é‡ä¹‹åï¼Œæˆ‘ä»¬çš„ä¿¡å·é‡æ˜¯ç©ºçš„ï¼Œæˆ‘ä»¬ä½¿ç”¨ <code>semawakeup</code> ä¿¡å·é‡æ‰ä¼šå¾—åˆ°ä¸€ä¸ªä¿¡å·ï¼Œæˆ‘ä»¬ä½¿ç”¨ <code>semasleep</code> æ˜¯ä¸ºäº†å¾—åˆ°ä¸€ä¸ªä¿¡å·é‡ï¼Œè¿™ä¸ªä¿¡å·é‡æ˜¯ <code>semawakeup</code> å‘é€è¿‡æ¥çš„ï¼Œå¦‚æœåœ¨æˆ‘ä»¬è§„å®šçš„æ—¶é—´æ‹¿ä¸åˆ°ä¿¡å·é‡ï¼Œæˆ–è€…ç¨‹åºä¸­æ–­ï¼Œéƒ½ä¼šè¿”å›-1ã€‚</p><h4 id=æŒæœ‰ç»“æ„>æŒæœ‰ç»“æ„</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-go data-lang=go><span class=c1>// initialized æ˜¯å¦è¢«åˆå§‹åŒ–
</span><span class=c1>// mutex äº’æ–¥é”
</span><span class=c1>// cond æ¡ä»¶é€šçŸ¥
</span><span class=c1>// count å½“å‰å¯ç›´æ¥è·å–çš„ä¿¡å·é‡æ•°é‡
</span><span class=c1></span><span class=kd>type</span> <span class=nx>mOS</span> <span class=kd>struct</span> <span class=p>{</span>
	<span class=nx>initialized</span> <span class=kt>bool</span>
	<span class=nx>mutex</span>       <span class=nx>pthreadmutex</span>
	<span class=nx>cond</span>        <span class=nx>pthreadcond</span>
	<span class=nx>count</span>       <span class=kt>int</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><p><code>semasleep</code> å’Œ <code>semawakeup</code> æœ¬è´¨éƒ½æ˜¯æ“ä½œ count<code> </code>çš„</p><p><code>semasleep</code> æ˜¯ <code>count - 1</code>ï¼Œå¦‚æœ <code>count == 0</code>ï¼Œå°±è¦ç­‰ä¸€ä¸ª <code>semawakeup</code> ç»™å®ƒåŠ 1</p><p><code>semawakeup</code> æ˜¯ <code>count + 1</code>ï¼Œå¦‚æœ +1 åçš„ <code>count</code> å¤§äº 0ï¼Œ æˆ‘ä»¬å°±è¦å”¤é†’ä¸€ä¸ªæ­£åœ¨<code>sleep</code></p><h4 id=semacreate>semacreate</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-go data-lang=go><span class=c1>// ç»™m.mOSçš„mutexå’Œcondåšåˆå§‹åŒ–ï¼Œå¦‚æœå·²ç»è¢«åˆå§‹åŒ–äº†å°±ç®—äº†
</span><span class=c1>// è¿™é‡Œçš„mutexå°±æ˜¯ä¸€ä¸ªäº’æ–¥ä½“ï¼Œé˜²æ­¢å¤šä¸ªçº¿ç¨‹å¹¶å‘è®¿é—®ä¿®æ”¹æ•°æ®å¯¼è‡´å‡ºé”™çš„
</span><span class=c1></span><span class=kd>func</span> <span class=nf>semacreate</span><span class=p>(</span><span class=nx>mp</span> <span class=o>*</span><span class=nx>m</span><span class=p>)</span> <span class=p>{</span>
    <span class=c1>// å¦‚æœå·²ç»è¢«åˆå§‹åŒ–ï¼Œå°±ä¸è¦å†åˆå§‹åŒ–äº†
</span><span class=c1></span>	<span class=k>if</span> <span class=nx>mp</span><span class=p>.</span><span class=nx>initialized</span> <span class=p>{</span>
		<span class=k>return</span>
	<span class=p>}</span>
	<span class=nx>mp</span><span class=p>.</span><span class=nx>initialized</span> <span class=p>=</span> <span class=kc>true</span>
   	<span class=c1>// åˆå§‹åŒ–é”ï¼Œäº’æ–¥ä½“
</span><span class=c1></span>	<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>pthread_mutex_init</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>mp</span><span class=p>.</span><span class=nx>mutex</span><span class=p>,</span> <span class=kc>nil</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=mi>0</span> <span class=p>{</span>
		<span class=nf>throw</span><span class=p>(</span><span class=s>&#34;pthread_mutex_init&#34;</span><span class=p>)</span>
	<span class=p>}</span>
    <span class=c1>// åˆå§‹åŒ–æ¡ä»¶é€šçŸ¥
</span><span class=c1></span>	<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>pthread_cond_init</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>mp</span><span class=p>.</span><span class=nx>cond</span><span class=p>,</span> <span class=kc>nil</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=mi>0</span> <span class=p>{</span>
		<span class=nf>throw</span><span class=p>(</span><span class=s>&#34;pthread_cond_init&#34;</span><span class=p>)</span>
	<span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><h4 id=semasleep>semasleep</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-go data-lang=go><span class=c1>// é˜»å¡æ¥è·å–ä¿¡å·
</span><span class=c1>// nså¦‚æœå°äº0ï¼Œå®ƒä¼šä¸€ç›´é˜»å¡ç­‰åˆ°èƒ½å¤Ÿè·å–ä¿¡å·ä¸ºæ­¢
</span><span class=c1>// nså¦‚æœå¤§äºç­‰äº0ï¼Œå®ƒä¼šæœ€å¤§é˜»å¡nsè¿™ä¹ˆé•¿çš„æ—¶é—´æ¥è·å–ä¿¡å·
</span><span class=c1>// æˆåŠŸè¿”å›0ï¼Œå¤±è´¥è¿”å›å…¶ä»–
</span><span class=c1></span><span class=kd>func</span> <span class=nf>semasleep</span><span class=p>(</span><span class=nx>ns</span> <span class=kt>int64</span><span class=p>)</span> <span class=kt>int32</span> <span class=p>{</span>
	<span class=kd>var</span> <span class=nx>start</span> <span class=kt>int64</span>
    <span class=c1>// å¦‚æœæˆ‘ä»¬æœ‰æœ€å¤§è€—æ—¶ï¼Œæˆ‘ä»¬å°±è¦å…ˆè®°å½•ä¸€ä¸‹æˆ‘ä»¬è°ƒç”¨æ—¶å€™çš„æ—¶é—´ï¼Œæ–¹ä¾¿åé¢ç®—èŠ±è´¹äº†å¤šé•¿æ—¶é—´
</span><span class=c1></span>	<span class=k>if</span> <span class=nx>ns</span> <span class=o>&gt;=</span> <span class=mi>0</span> <span class=p>{</span>
		<span class=nx>start</span> <span class=p>=</span> <span class=nf>nanotime</span><span class=p>()</span>
	<span class=p>}</span>
    <span class=c1>// å¾—åˆ°m
</span><span class=c1></span>	<span class=nx>mp</span> <span class=o>:=</span> <span class=nf>getg</span><span class=p>().</span><span class=nx>m</span>
    <span class=c1>// ä¸Šé”
</span><span class=c1></span>	<span class=nf>pthread_mutex_lock</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>mp</span><span class=p>.</span><span class=nx>mutex</span><span class=p>)</span>
	<span class=k>for</span> <span class=p>{</span>
        <span class=c1>// mp.countåªæœ‰åœ¨å”¤é†’ä¸€ä¸ªä¿¡å·çš„æ—¶å€™æ‰ä¼šå¢åŠ 
</span><span class=c1></span>		<span class=k>if</span> <span class=nx>mp</span><span class=p>.</span><span class=nx>count</span> <span class=p>&gt;</span> <span class=mi>0</span> <span class=p>{</span>
            <span class=c1>// å¦‚æœé‡Œé¢å¾—åˆ°ä¸€ä¸ªä¿¡å·ï¼Œæˆ‘ä»¬å°±è®©å®ƒ--
</span><span class=c1></span>			<span class=nx>mp</span><span class=p>.</span><span class=nx>count</span><span class=o>--</span>
            <span class=c1>// è§£é”å°±å¥½äº†
</span><span class=c1></span>			<span class=nf>pthread_mutex_unlock</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>mp</span><span class=p>.</span><span class=nx>mutex</span><span class=p>)</span>
			<span class=k>return</span> <span class=mi>0</span>
		<span class=p>}</span>
        <span class=c1>// ns &gt;= 0 è¯´æ˜æˆ‘ä»¬æœ‰ä¸€ä¸ªè€—æ—¶æ£€æµ‹
</span><span class=c1></span>		<span class=k>if</span> <span class=nx>ns</span> <span class=o>&gt;=</span> <span class=mi>0</span> <span class=p>{</span>
            <span class=c1>// åˆ¤æ–­ä¸€ä¸‹æˆ‘ä»¬å½“å‰èŠ±è´¹çš„æ—¶é—´æ˜¯ä¸æ˜¯è¶…è¿‡æˆ‘ä»¬çš„è€—æ—¶äº†
</span><span class=c1></span>			<span class=nx>spent</span> <span class=o>:=</span> <span class=nf>nanotime</span><span class=p>()</span> <span class=o>-</span> <span class=nx>start</span>
			<span class=k>if</span> <span class=nx>spent</span> <span class=o>&gt;=</span> <span class=nx>ns</span> <span class=p>{</span>
                <span class=c1>// è¶…è¿‡æˆ‘ä»¬å°±è§£é”å¹¶è¿”å›-1
</span><span class=c1></span>				<span class=nf>pthread_mutex_unlock</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>mp</span><span class=p>.</span><span class=nx>mutex</span><span class=p>)</span>
				<span class=k>return</span> <span class=o>-</span><span class=mi>1</span>
			<span class=p>}</span>
            <span class=c1>// tæ˜¯ä¸€ä¸ªæ—¶é—´é‡
</span><span class=c1></span>			<span class=kd>var</span> <span class=nx>t</span> <span class=nx>timespec</span>
            <span class=c1>// è®¡ç®—å‰©ä½™tçš„å€¼
</span><span class=c1></span>			<span class=nx>t</span><span class=p>.</span><span class=nf>setNsec</span><span class=p>(</span><span class=nx>ns</span> <span class=o>-</span> <span class=nx>spent</span><span class=p>)</span>
            <span class=c1>// æˆ‘ä»¬å¼€å§‹ç­‰å¾…ä¸€ä¸ªæ¡ä»¶é€šçŸ¥ï¼Œè®©æˆ‘ä»¬èƒ½ç»§ç»­æ‰§è¡Œï¼Œæœ€é•¿é˜»å¡æ—¶é—´ä¸ºtï¼Œè¿™é‡Œé¢ä¼ å…¥mutexä¹Ÿæ˜¯ä¸ºäº†ä¸Šé”ï¼Œé‡Œé¢å¥½ä¿®æ”¹çŠ¶æ€
</span><span class=c1></span>			<span class=nx>err</span> <span class=o>:=</span> <span class=nf>pthread_cond_timedwait_relative_np</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>mp</span><span class=p>.</span><span class=nx>cond</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>mp</span><span class=p>.</span><span class=nx>mutex</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>t</span><span class=p>)</span>
            <span class=c1>// å¦‚æœè¶…æ—¶ï¼Œæˆ‘ä»¬å°±è¿”å›-1
</span><span class=c1></span>			<span class=k>if</span> <span class=nx>err</span> <span class=o>==</span> <span class=nx>_ETIMEDOUT</span> <span class=p>{</span>
				<span class=nf>pthread_mutex_unlock</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>mp</span><span class=p>.</span><span class=nx>mutex</span><span class=p>)</span>
				<span class=k>return</span> <span class=o>-</span><span class=mi>1</span>
			<span class=p>}</span>
            <span class=c1>// æ²¡æœ‰è¶…æ—¶ï¼Œæˆ‘ä»¬å°±ç»§ç»­å¾ªç¯äº†
</span><span class=c1></span>            <span class=c1>// å¦‚æœæ²¡æœ‰è¶…æ—¶ï¼Œè¯æ˜condå¾—åˆ°äº†ä¸€ä¸ªé€šçŸ¥ï¼Œæˆ‘ä»¬çš„m.countæ˜¯ä¼š++çš„ï¼Œåœ¨ä¸Šé¢ä¼šæ­£å¸¸ç»“æŸè¿”å›0
</span><span class=c1></span>		<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
            <span class=c1>// å¦‚æœæˆ‘ä»¬è®©æ— é™ç­‰å¾…ï¼Œä¸”å½“å‰æ²¡æœ‰å¾—åˆ°ä¸€ä¸ªä¿¡å·ï¼Œæˆ‘ä»¬å°±ç›´æ¥ç­‰é€šçŸ¥å°±å¥½äº†
</span><span class=c1></span>			<span class=nf>pthread_cond_wait</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>mp</span><span class=p>.</span><span class=nx>cond</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>mp</span><span class=p>.</span><span class=nx>mutex</span><span class=p>)</span>
            <span class=c1>// æ‹¿åˆ°é€šçŸ¥åï¼Œå†å¾ªç¯åˆ°ä¸Šé¢countè‚¯å®šä¹Ÿä¼šå¤§äº0ï¼Œå°±è¿”å›0å°±å¥½äº†
</span><span class=c1></span>		<span class=p>}</span>
	<span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><h4 id=semawakeup>semawakeup</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-go data-lang=go><span class=c1>// å”¤é†’ä¸€ä¸ªä¿¡å·ï¼Œä¸ºæˆ‘ä»¬çš„count++ï¼Œå¹¶ä½¿ç”¨cond_signalè¿›è¡Œé€šçŸ¥
</span><span class=c1></span><span class=kd>func</span> <span class=nf>semawakeup</span><span class=p>(</span><span class=nx>mp</span> <span class=o>*</span><span class=nx>m</span><span class=p>)</span> <span class=p>{</span>
   <span class=c1>// åŠ é”ï¼Œå› ä¸ºè¦æ“ä½œmäº†
</span><span class=c1></span>   <span class=nf>pthread_mutex_lock</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>mp</span><span class=p>.</span><span class=nx>mutex</span><span class=p>)</span>
   <span class=nx>mp</span><span class=p>.</span><span class=nx>count</span><span class=o>++</span>
   <span class=k>if</span> <span class=nx>mp</span><span class=p>.</span><span class=nx>count</span> <span class=p>&gt;</span> <span class=mi>0</span> <span class=p>{</span>
      <span class=c1>// å¦‚æœcount&gt;0ï¼Œä»£è¡¨æŒæœ‰ä¿¡å·é‡ï¼Œæˆ‘ä»¬å°±é€šçŸ¥cond
</span><span class=c1></span>      <span class=nf>pthread_cond_signal</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>mp</span><span class=p>.</span><span class=nx>cond</span><span class=p>)</span>
   <span class=p>}</span>
   <span class=nf>pthread_mutex_unlock</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>mp</span><span class=p>.</span><span class=nx>mutex</span><span class=p>)</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><h3 id=mutex-çš„åŠ è§£é”æ“ä½œ>mutex çš„åŠ è§£é”æ“ä½œ</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-go data-lang=go><span class=c1>// locked ç”¨æœ€ä½ä½æ˜¯ä¸æ˜¯1æ¥åˆ¤æ–­æ˜¯å¦å¤„äºé”å®šçŠ¶æ€
</span><span class=c1>// active_spin ç§¯æè‡ªæ—‹çš„æ¬¡æ•°
</span><span class=c1>// passive_spin æ¶ˆæè‡ªæ—‹çš„æ¬¡æ•°
</span><span class=c1>// active_spin_cnt ç”¨æ¥è‡ªæ—‹ç­‰å¾…çš„
</span><span class=c1></span><span class=kd>const</span> <span class=p>(</span>
	<span class=nx>locked</span> <span class=kt>uintptr</span> <span class=p>=</span> <span class=mi>1</span>

	<span class=nx>active_spin</span>     <span class=p>=</span> <span class=mi>4</span>
	<span class=nx>active_spin_cnt</span> <span class=p>=</span> <span class=mi>30</span>
	<span class=nx>passive_spin</span>    <span class=p>=</span> <span class=mi>1</span>
<span class=p>)</span>
</code></pre></td></tr></table></div></div><h4 id=è·å–é”-lock>è·å–é” lock</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-go data-lang=go><span class=kd>func</span> <span class=nf>lock</span><span class=p>(</span><span class=nx>l</span> <span class=o>*</span><span class=nx>mutex</span><span class=p>)</span> <span class=p>{</span>
    <span class=c1>// lockWithRank åœ¨ç¬¬ä¸‰ç¯‡æ–‡ç« è®²åˆ°äº†ï¼Œå°±ä¸è¯´äº†
</span><span class=c1></span>    <span class=c1>// åˆ¤æ–­é”æ’åæ˜¯å¦åˆæ³•
</span><span class=c1></span>	<span class=nf>lockWithRank</span><span class=p>(</span><span class=nx>l</span><span class=p>,</span> <span class=nf>getLockRank</span><span class=p>(</span><span class=nx>l</span><span class=p>))</span>
<span class=p>}</span>

<span class=c1>// åŠ é”æ“ä½œ
</span><span class=c1></span><span class=kd>func</span> <span class=nf>lock2</span><span class=p>(</span><span class=nx>l</span> <span class=o>*</span><span class=nx>mutex</span><span class=p>)</span> <span class=p>{</span>
    <span class=c1>// å¾—åˆ°g
</span><span class=c1></span>	<span class=nx>gp</span> <span class=o>:=</span> <span class=nf>getg</span><span class=p>()</span>
    <span class=c1>// åˆ¤æ–­mä¸Šé”çš„æ•°é‡æ˜¯ä¸æ˜¯å¼‚å¸¸çš„
</span><span class=c1></span>	<span class=k>if</span> <span class=nx>gp</span><span class=p>.</span><span class=nx>m</span><span class=p>.</span><span class=nx>locks</span> <span class=p>&lt;</span> <span class=mi>0</span> <span class=p>{</span>
		<span class=nf>throw</span><span class=p>(</span><span class=s>&#34;runtimeÂ·lock: lock count&#34;</span><span class=p>)</span>
	<span class=p>}</span>
    <span class=c1>// ç»™lock++
</span><span class=c1></span>	<span class=nx>gp</span><span class=p>.</span><span class=nx>m</span><span class=p>.</span><span class=nx>locks</span><span class=o>++</span>

	<span class=c1>// casæ“ä½œï¼Œåˆ¤æ–­l.keyæ˜¯ä¸æ˜¯0ï¼Œå¦‚æœæ˜¯0ï¼Œæˆ‘ä»¬è®¾ç½®æˆlockedï¼Œå°±ç»“æŸäº†
</span><span class=c1></span>	<span class=k>if</span> <span class=nx>atomic</span><span class=p>.</span><span class=nf>Casuintptr</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>l</span><span class=p>.</span><span class=nx>key</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>locked</span><span class=p>)</span> <span class=p>{</span>
		<span class=k>return</span>
	<span class=p>}</span>
    <span class=c1>// å¦‚æœä¸æ˜¯0ï¼Œæˆ‘ä»¬å…ˆåˆå§‹åŒ–ä¸€ä¸‹ä¿¡å·é‡
</span><span class=c1></span>	<span class=nf>semacreate</span><span class=p>(</span><span class=nx>gp</span><span class=p>.</span><span class=nx>m</span><span class=p>)</span>

	<span class=c1>// å•æ ¸å¤„ç†å™¨ä¸è‡ªæ—‹ï¼Œå¤šæ ¸å¤„ç†å™¨è‡ªæ—‹
</span><span class=c1></span>	<span class=nx>spin</span> <span class=o>:=</span> <span class=mi>0</span>
	<span class=k>if</span> <span class=nx>ncpu</span> <span class=p>&gt;</span> <span class=mi>1</span> <span class=p>{</span>
        <span class=c1>// è‡ªæ—‹4æ¬¡
</span><span class=c1></span>		<span class=nx>spin</span> <span class=p>=</span> <span class=nx>active_spin</span>
	<span class=p>}</span>
<span class=nx>Loop</span><span class=p>:</span>
    <span class=c1>// è¿›å…¥ä¸€ä¸ªå¾ªç¯
</span><span class=c1></span>	<span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=mi>0</span><span class=p>;</span> <span class=p>;</span> <span class=nx>i</span><span class=o>++</span> <span class=p>{</span>
        <span class=c1>// è·å–keyçš„å€¼
</span><span class=c1></span>		<span class=nx>v</span> <span class=o>:=</span> <span class=nx>atomic</span><span class=p>.</span><span class=nf>Loaduintptr</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>l</span><span class=p>.</span><span class=nx>key</span><span class=p>)</span>
        <span class=c1>// åˆ¤æ–­keyçš„æœ€ä½ä½æ˜¯ä¸æ˜¯0
</span><span class=c1></span>		<span class=k>if</span> <span class=nx>v</span><span class=o>&amp;</span><span class=nx>locked</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span>
			<span class=c1>// æ˜¯0çš„è¯ï¼Œè¯æ˜å¯ä»¥ç›´æ¥åŠ é”
</span><span class=c1></span>            <span class=c1>// æˆ‘ä»¬å°è¯•casåŠ é”ï¼Œå¦‚æœå¤±è´¥äº†ï¼Œæˆ‘ä»¬å°±è®©é‡æ–°å¼€å§‹è‡ªæ—‹
</span><span class=c1></span>			<span class=k>if</span> <span class=nx>atomic</span><span class=p>.</span><span class=nf>Casuintptr</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>l</span><span class=p>.</span><span class=nx>key</span><span class=p>,</span> <span class=nx>v</span><span class=p>,</span> <span class=nx>v</span><span class=p>|</span><span class=nx>locked</span><span class=p>)</span> <span class=p>{</span>
				<span class=k>return</span>
			<span class=p>}</span>
            <span class=c1>// å¦‚æœè¿˜æ˜¯è¢«é”å®šçš„ï¼Œæˆ‘ä»¬å°±é‡æ–°è‡ªæ—‹
</span><span class=c1></span>			<span class=nx>i</span> <span class=p>=</span> <span class=mi>0</span>
		<span class=p>}</span>
        
		<span class=k>if</span> <span class=nx>i</span> <span class=p>&lt;</span> <span class=nx>spin</span> <span class=p>{</span>
            <span class=c1>// i å¦‚æœå°äºè‡ªæ—‹æ¬¡æ•°ï¼Œè°ƒç”¨procyieldï¼Œèµ„æºæ¶ˆè€—å°
</span><span class=c1></span>            <span class=c1>// é˜»å¡ä¸€ä¸‹
</span><span class=c1></span>			<span class=nf>procyield</span><span class=p>(</span><span class=nx>active_spin_cnt</span><span class=p>)</span>
		<span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=nx>i</span> <span class=p>&lt;</span> <span class=nx>spin</span><span class=o>+</span><span class=nx>passive_spin</span> <span class=p>{</span>
            <span class=c1>// å¦‚æœiå¤§äºç­‰äºè‡ªæ—‹æ¬¡æ•°ï¼Œæˆ‘ä»¬åˆ¤æ–­æ˜¯ä¸æ˜¯è¿˜å°äºåŠ ä¸Šæ¶ˆæçš„è‡ªæ—‹æ¬¡æ•°ï¼Œå°±æ‰§è¡Œosyieldï¼Œèµ„æºæ¶ˆè€—å¤§
</span><span class=c1></span>            <span class=c1>// é˜»å¡ä¸€ä¸‹
</span><span class=c1></span>			<span class=nf>osyield</span><span class=p>()</span>
		<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
            <span class=c1>// ä¸ç”¨è‡ªæ—‹äº†ï¼Œæˆ‘ä»¬è¦ç»™è¿™ä¸ªmutexè¿›è¡Œå…¥é˜Ÿç­‰å¾…äº†
</span><span class=c1></span>			<span class=c1>// l.key æŒ‚è½½çš„æ˜¯ç­‰å¾…è¿™ä¸ªé”çš„ m çš„é“¾è¡¨
</span><span class=c1></span>			<span class=c1>// é€šè¿‡ nextwaitm æ¥æ’é˜Ÿ
</span><span class=c1></span>			<span class=k>for</span> <span class=p>{</span>
                <span class=c1>// gp.m.nextwaitm è®¾ç½®æˆçš„ vä¸­çš„mï¼Œä¹Ÿå°±æ˜¯åŸæ¥çš„m
</span><span class=c1></span>                <span class=c1>// l.keyè®¾ç½®æˆç°åœ¨çš„m
</span><span class=c1></span>                <span class=c1>// é‚£ä¹ˆå…³ç³»å°±æ˜¯l.keyæ˜¯ç°åœ¨çš„m
</span><span class=c1></span>                <span class=c1>// l.keyçš„mçš„nextwaitmæ˜¯ä¸Šä¸€ä¸ªmäº†
</span><span class=c1></span>                <span class=c1>// ç›¸å½“äºå…¥é˜Ÿåˆ°å¤´éƒ¨äº†
</span><span class=c1></span>				<span class=nx>gp</span><span class=p>.</span><span class=nx>m</span><span class=p>.</span><span class=nx>nextwaitm</span> <span class=p>=</span> <span class=nf>muintptr</span><span class=p>(</span><span class=nx>v</span> <span class=o>&amp;^</span> <span class=nx>locked</span><span class=p>)</span>
                <span class=c1>// å¦‚æœvåœ¨ä¸­é€”æ²¡æœ‰è¢«è§£é”ï¼Œæˆ‘ä»¬å°±æŠŠvè®¾ç½®æˆå½“å‰mçš„åœ°å€ï¼Œæœ€åä¸€ä½è®¾ç½®æˆé”å®šä¸­
</span><span class=c1></span>				<span class=k>if</span> <span class=nx>atomic</span><span class=p>.</span><span class=nf>Casuintptr</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>l</span><span class=p>.</span><span class=nx>key</span><span class=p>,</span> <span class=nx>v</span><span class=p>,</span> <span class=nb>uintptr</span><span class=p>(</span><span class=nx>unsafe</span><span class=p>.</span><span class=nf>Pointer</span><span class=p>(</span><span class=nx>gp</span><span class=p>.</span><span class=nx>m</span><span class=p>))|</span><span class=nx>locked</span><span class=p>)</span> <span class=p>{</span>
					<span class=k>break</span>
				<span class=p>}</span>
                <span class=c1>// å¦‚æœvè¢«å…¶ä»–çº¿ç¨‹æ”¹å˜äº†ï¼Œé‡æ–°å»ä¸€ä¸‹vçš„æ–°å€¼ï¼ˆå…¶ä»–çº¿ç¨‹å¯èƒ½è§£é”äº†è¿™ä¸ªvï¼‰
</span><span class=c1></span>				<span class=nx>v</span> <span class=p>=</span> <span class=nx>atomic</span><span class=p>.</span><span class=nf>Loaduintptr</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>l</span><span class=p>.</span><span class=nx>key</span><span class=p>)</span>
                <span class=c1>// å¦‚æœvå½“å‰å¤„äºè§£é”çŠ¶æ€äº†
</span><span class=c1></span>				<span class=k>if</span> <span class=nx>v</span><span class=o>&amp;</span><span class=nx>locked</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span>
                    <span class=c1>// ç»§ç»­å¤–éƒ¨å¾ªç¯äº†
</span><span class=c1></span>					<span class=k>continue</span> <span class=nx>Loop</span>
				<span class=p>}</span>
			<span class=p>}</span>
            <span class=c1>// å¦‚æœvé”å®šä¸­ï¼Œæˆ‘ä»¬å°±æŒ‚èµ·ç­‰å¾…
</span><span class=c1></span>			<span class=k>if</span> <span class=nx>v</span><span class=o>&amp;</span><span class=nx>locked</span> <span class=o>!=</span> <span class=mi>0</span> <span class=p>{</span>
				<span class=c1>// ç­‰å¾…
</span><span class=c1></span>				<span class=nf>semasleep</span><span class=p>(</span><span class=o>-</span><span class=mi>1</span><span class=p>)</span>
				<span class=nx>i</span> <span class=p>=</span> <span class=mi>0</span>
			<span class=p>}</span>
		<span class=p>}</span>
	<span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><h5 id=å½“ä¸€ä¸ªçº¿ç¨‹éœ€è¦è·å–ä¸€ä¸ªé”çš„æ—¶å€™ä»–æ‰§è¡Œæµç¨‹å¦‚ä¸‹>å½“ä¸€ä¸ªçº¿ç¨‹éœ€è¦è·å–ä¸€ä¸ªé”çš„æ—¶å€™ï¼Œä»–æ‰§è¡Œæµç¨‹å¦‚ä¸‹</h5><ol><li>åˆ¤æ–­keyçš„å€¼ç­‰äº0ï¼ˆä¹Ÿå°±æ˜¯ä¸€ä¸ªæ–°é”ï¼‰ï¼Œé‚£ä¹ˆå°±ç›´æ¥è®¾ç½®ä¸º1é”å®šçŠ¶æ€ï¼Œå¹¶è¿”å›</li><li>å¦‚æœkeyä¸æ˜¯0ï¼Œè¯æ˜é‡Œé¢è¦ä¹ˆæ˜¯1ï¼Œè¦ä¹ˆæ˜¯å­˜äº†ä¸€ä¸ªwaitmï¼Œæˆ‘ä»¬å°±è¦åˆå§‹åŒ–ä¿¡å·é”ï¼ˆæ›´åº•å±‚ï¼Œä»…ä¼šåˆå§‹åŒ–ä¸€æ¬¡ï¼‰</li><li>è·å–æ˜¯å¦åº”è¯¥è‡ªæ—‹å’Œè®¾ç½®è‡ªæ—‹æ¬¡æ•°</li><li>è¿›å…¥è‡ªæ—‹ä¹Ÿå°±æ˜¯å¾ªç¯ï¼Œæ­¤æ—¶keyå¯èƒ½æ˜¯1æˆ–è€…æ˜¯ä¸€ä¸ªwaitmï¼Œwaitmçš„æœ€ä½ä½æ ‡å¿—ç€å½“å‰é”çš„çŠ¶æ€ï¼Œæˆ‘ä»¬åˆ¤æ–­æœ€ä½ä½ç­‰äº0ï¼Œæˆ‘ä»¬ç›´æ¥è®¾ç½®æœ€ä½ä½ä¸º1ï¼Œè¿”å›å³å¯</li><li>å¦‚æœè®¾ç½®æœ€ä½ä½ä¸º1å¤±è´¥ï¼ˆå…¶ä»–çº¿ç¨‹æŠ¢å…ˆä¸€æ­¥ä¿®æ”¹äº†ï¼‰ï¼Œæˆ‘ä»¬éœ€è¦é‡æ–°è‡ªæ—‹</li><li>åœ¨ä¸Šä¸€æ­¥éªŒè¯ç»“æŸåï¼Œå¦‚æœè‡ªæ—‹æ¬¡æ•°è¿˜æœªå¾ªç¯ç»“æŸï¼Œæˆ‘ä»¬è®©å¤„ç†å™¨æ‰§è¡Œç­‰å¾…ï¼Œåç»§ç»­å¾ªç¯è·å–é”çŠ¶æ€</li><li>å¦‚æœè‡ªæ—‹æ¬¡æ•°ç»“æŸï¼Œæ— æ³•è·å–åˆ°é”ï¼Œæˆ‘ä»¬å°±è®©å½“å‰mçš„nextwaitmæŒ‡å‘keyï¼Œä¹Ÿå°±æ˜¯å‰é¢æ­£åœ¨é˜»å¡çš„mçš„åœ°å€ï¼Œè®©æˆ‘ä»¬çš„keyå­˜å‚¨å½“å‰mçš„åœ°å€</li><li>å¦‚æœå­˜å‚¨æˆ‘ä»¬çš„må¤±è´¥ï¼Œè¯æ˜å½“å‰é”å·²ç»è¢«å…¶ä»–çº¿ç¨‹é‡Šæ”¾äº†ï¼Œæˆ‘ä»¬å°±ç»§ç»­åˆ¤æ–­ï¼Œé‡æ–°è¿›å…¥è‡ªæ—‹çŠ¶æ€</li><li>å¦‚æœå­˜å‚¨æˆåŠŸï¼Œæˆ‘ä»¬å°±ç­‰å¾…semaä¿¡å·çš„é€šçŸ¥å³å¯</li></ol><h5 id=ä¸ºä»€ä¹ˆmè¦é€šè¿‡é‚£ç§æ–¹å¼è®¾ç½®æˆ‘ä»¬ä¸¾ä¸ªä¾‹å­ä»–è¿™ä¸ªç®—æ³•å¾ˆå·§å¦™>ä¸ºä»€ä¹ˆmè¦é€šè¿‡é‚£ç§æ–¹å¼è®¾ç½®ï¼Œæˆ‘ä»¬ä¸¾ä¸ªä¾‹å­ï¼Œä»–è¿™ä¸ªç®—æ³•å¾ˆå·§å¦™ã€‚</h5><table><thead><tr><th style=text-align:center></th><th>åœ°å€ä¸è®¡ç®—</th><th>å¤‡æ³¨</th></tr></thead><tbody><tr><td style=text-align:center>m</td><td>0x1000</td><td>må°±æ˜¯æˆ‘ä»¬çš„çº¿ç¨‹åœ°å€</td></tr><tr><td style=text-align:center>waitm</td><td>0x1001 (0x1000 &^ 0x1)</td><td>waitmå°±æ˜¯æˆ‘ä»¬çš„nextwaitm</td></tr><tr><td style=text-align:center>key</td><td>0x1001 (0x1000 | 0x1)</td><td>keyå°±æ˜¯mutexé‡Œé¢å­˜å‚¨çš„</td></tr><tr><td style=text-align:center>getm</td><td>0x1000 (0x1001 &^ 0x1)</td><td>getmå°±æ˜¯é‡Šæ”¾é”æ—¶ä»keyé‡Œå–åˆ°çš„m</td></tr></tbody></table><h4 id=é‡Šæ”¾é”>é‡Šæ”¾é”</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-go data-lang=go><span class=kd>func</span> <span class=nf>unlock</span><span class=p>(</span><span class=nx>l</span> <span class=o>*</span><span class=nx>mutex</span><span class=p>)</span> <span class=p>{</span>
	<span class=nf>unlockWithRank</span><span class=p>(</span><span class=nx>l</span><span class=p>)</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=nf>unlock2</span><span class=p>(</span><span class=nx>l</span> <span class=o>*</span><span class=nx>mutex</span><span class=p>)</span> <span class=p>{</span>
    <span class=c1>// è·å–g
</span><span class=c1></span>	<span class=nx>gp</span> <span class=o>:=</span> <span class=nf>getg</span><span class=p>()</span>
	<span class=kd>var</span> <span class=nx>mp</span> <span class=o>*</span><span class=nx>m</span>
	<span class=k>for</span> <span class=p>{</span>
        <span class=c1>// è·å–é”ä¸Šå­˜çš„keyï¼Œä¹Ÿå°±æ˜¯waitmä»¥åŠé”å®šçŠ¶æ€
</span><span class=c1></span>		<span class=nx>v</span> <span class=o>:=</span> <span class=nx>atomic</span><span class=p>.</span><span class=nf>Loaduintptr</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>l</span><span class=p>.</span><span class=nx>key</span><span class=p>)</span>
        <span class=c1>// å¦‚æœé”å®šä¸­ï¼Œç›´æ¥è§£é”
</span><span class=c1></span>		<span class=k>if</span> <span class=nx>v</span> <span class=o>==</span> <span class=nx>locked</span> <span class=p>{</span>
            <span class=c1>// casæ“ä½œè§£é”
</span><span class=c1></span>			<span class=k>if</span> <span class=nx>atomic</span><span class=p>.</span><span class=nf>Casuintptr</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>l</span><span class=p>.</span><span class=nx>key</span><span class=p>,</span> <span class=nx>locked</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
				<span class=k>break</span>
			<span class=p>}</span>
		<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
            <span class=c1>// å½“å‰vä¸æ˜¯å•çº¯çš„é”å®šçŠ¶æ€ï¼Œé‡Œé¢å­˜å‚¨äº†mä¿¡æ¯
</span><span class=c1></span>            <span class=c1>// å–åˆ°mçš„æŒ‡é’ˆ
</span><span class=c1></span>			<span class=nx>mp</span> <span class=p>=</span> <span class=nf>muintptr</span><span class=p>(</span><span class=nx>v</span> <span class=o>&amp;^</span> <span class=nx>locked</span><span class=p>).</span><span class=nf>ptr</span><span class=p>()</span>
            <span class=c1>// è®©æˆ‘ä»¬çš„keyæŒ‡å‘ä¸‹ä¸€ä¸ªç­‰å¾…çš„mèº«ä¸Š
</span><span class=c1></span>			<span class=k>if</span> <span class=nx>atomic</span><span class=p>.</span><span class=nf>Casuintptr</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>l</span><span class=p>.</span><span class=nx>key</span><span class=p>,</span> <span class=nx>v</span><span class=p>,</span> <span class=nb>uintptr</span><span class=p>(</span><span class=nx>mp</span><span class=p>.</span><span class=nx>nextwaitm</span><span class=p>))</span> <span class=p>{</span>
                <span class=c1>// å”¤é†’mp
</span><span class=c1></span>				<span class=nf>semawakeup</span><span class=p>(</span><span class=nx>mp</span><span class=p>)</span>
				<span class=k>break</span>
			<span class=p>}</span>
		<span class=p>}</span>
	<span class=p>}</span>
    <span class=c1>// è§£é”æˆåŠŸ
</span><span class=c1></span>	<span class=nx>gp</span><span class=p>.</span><span class=nx>m</span><span class=p>.</span><span class=nx>locks</span><span class=o>--</span>
	<span class=k>if</span> <span class=nx>gp</span><span class=p>.</span><span class=nx>m</span><span class=p>.</span><span class=nx>locks</span> <span class=p>&lt;</span> <span class=mi>0</span> <span class=p>{</span>
		<span class=nf>throw</span><span class=p>(</span><span class=s>&#34;runtimeÂ·unlock: lock count&#34;</span><span class=p>)</span>
	<span class=p>}</span>
    <span class=c1>// å¦‚æœmä¸Šæ²¡æœ‰é”äº†ï¼Œå°±æ¢å¤æŠ¢å è¯·æ±‚
</span><span class=c1></span>	<span class=k>if</span> <span class=nx>gp</span><span class=p>.</span><span class=nx>m</span><span class=p>.</span><span class=nx>locks</span> <span class=o>==</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=nx>gp</span><span class=p>.</span><span class=nx>preempt</span> <span class=p>{</span> <span class=c1>// restore the preemption request in case we&#39;ve cleared it in newstack
</span><span class=c1></span>		<span class=nx>gp</span><span class=p>.</span><span class=nx>stackguard0</span> <span class=p>=</span> <span class=nx>stackPreempt</span>
	<span class=p>}</span>
<span class=p>}</span>

</code></pre></td></tr></table></div></div><h2 id=mutexåŸºäºfutexçš„å®ç°>mutexåŸºäºfutexçš„å®ç°</h2><h3 id=è·å–é”>è·å–é”</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-go data-lang=go><span class=kd>func</span> <span class=nf>lock</span><span class=p>(</span><span class=nx>l</span> <span class=o>*</span><span class=nx>mutex</span><span class=p>)</span> <span class=p>{</span>
	<span class=nf>lockWithRank</span><span class=p>(</span><span class=nx>l</span><span class=p>,</span> <span class=nf>getLockRank</span><span class=p>(</span><span class=nx>l</span><span class=p>))</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=nf>lock2</span><span class=p>(</span><span class=nx>l</span> <span class=o>*</span><span class=nx>mutex</span><span class=p>)</span> <span class=p>{</span>
    <span class=c1>// æ‹¿åˆ°g
</span><span class=c1></span>	<span class=nx>gp</span> <span class=o>:=</span> <span class=nf>getg</span><span class=p>()</span>
	<span class=k>if</span> <span class=nx>gp</span><span class=p>.</span><span class=nx>m</span><span class=p>.</span><span class=nx>locks</span> <span class=p>&lt;</span> <span class=mi>0</span> <span class=p>{</span>
		<span class=nf>throw</span><span class=p>(</span><span class=s>&#34;runtimeÂ·lock: lock count&#34;</span><span class=p>)</span>
	<span class=p>}</span>
	<span class=nx>gp</span><span class=p>.</span><span class=nx>m</span><span class=p>.</span><span class=nx>locks</span><span class=o>++</span>

	<span class=c1>// æŠŠl.keyè®¾ç½®æˆmutex_locked
</span><span class=c1></span>	<span class=nx>v</span> <span class=o>:=</span> <span class=nx>atomic</span><span class=p>.</span><span class=nf>Xchg</span><span class=p>(</span><span class=nf>key32</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>l</span><span class=p>.</span><span class=nx>key</span><span class=p>),</span> <span class=nx>mutex_locked</span><span class=p>)</span>
    <span class=c1>// åˆ¤æ–­åŸæ¥l.keyæ˜¯ä¸æ˜¯è§£é”çŠ¶æ€ï¼Œæ‹¿åˆ°é”äº†
</span><span class=c1></span>	<span class=k>if</span> <span class=nx>v</span> <span class=o>==</span> <span class=nx>mutex_unlocked</span> <span class=p>{</span>
		<span class=k>return</span>
	<span class=p>}</span>

    <span class=c1>// wait ç°åœ¨æ˜¯ MUTEX_LOCKED æˆ–è€… MUTEX_SLEEPINGçŠ¶æ€
</span><span class=c1></span>	<span class=nx>wait</span> <span class=o>:=</span> <span class=nx>v</span>

	<span class=nx>spin</span> <span class=o>:=</span> <span class=mi>0</span>
	<span class=k>if</span> <span class=nx>ncpu</span> <span class=p>&gt;</span> <span class=mi>1</span> <span class=p>{</span>
		<span class=nx>spin</span> <span class=p>=</span> <span class=nx>active_spin</span>
	<span class=p>}</span>
	<span class=k>for</span> <span class=p>{</span>
		<span class=c1>// ç§¯æè‡ªæ—‹ï¼Œå†æ¬¡å°è¯•è§£é”
</span><span class=c1></span>		<span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>i</span> <span class=p>&lt;</span> <span class=nx>spin</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span> <span class=p>{</span>
            <span class=c1>// å¦‚æœå…¶ä»–çº¿ç¨‹æŠŠé”é‡Šæ”¾äº†ï¼Œæˆ‘ä»¬è¿™è¾¹å°±èƒ½æ‹¿åˆ°äº†ï¼Œå¹¶ä¸”æŠŠé”çŠ¶æ€ï¼Œè®¾ç½®æˆæˆ‘ä»¬ä¸Šé¢æœ¬æ¥çš„çŠ¶æ€
</span><span class=c1></span>			<span class=k>for</span> <span class=nx>l</span><span class=p>.</span><span class=nx>key</span> <span class=o>==</span> <span class=nx>mutex_unlocked</span> <span class=p>{</span>
				<span class=k>if</span> <span class=nx>atomic</span><span class=p>.</span><span class=nf>Cas</span><span class=p>(</span><span class=nf>key32</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>l</span><span class=p>.</span><span class=nx>key</span><span class=p>),</span> <span class=nx>mutex_unlocked</span><span class=p>,</span> <span class=nx>wait</span><span class=p>)</span> <span class=p>{</span>
					<span class=k>return</span>
				<span class=p>}</span>
			<span class=p>}</span>
			<span class=nf>procyield</span><span class=p>(</span><span class=nx>active_spin_cnt</span><span class=p>)</span>
		<span class=p>}</span>

		<span class=c1>// æ¶ˆæè‡ªæ—‹ï¼Œä¸ä¸Šé¢ç›¸åŒï¼Œå°±æ˜¯æ¢æˆäº†osyield
</span><span class=c1></span>		<span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>i</span> <span class=p>&lt;</span> <span class=nx>passive_spin</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span> <span class=p>{</span>
			<span class=k>for</span> <span class=nx>l</span><span class=p>.</span><span class=nx>key</span> <span class=o>==</span> <span class=nx>mutex_unlocked</span> <span class=p>{</span>
				<span class=k>if</span> <span class=nx>atomic</span><span class=p>.</span><span class=nf>Cas</span><span class=p>(</span><span class=nf>key32</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>l</span><span class=p>.</span><span class=nx>key</span><span class=p>),</span> <span class=nx>mutex_unlocked</span><span class=p>,</span> <span class=nx>wait</span><span class=p>)</span> <span class=p>{</span>
					<span class=k>return</span>
				<span class=p>}</span>
			<span class=p>}</span>
			<span class=nf>osyield</span><span class=p>()</span>
		<span class=p>}</span>

		<span class=c1>// æˆ‘ä»¬å†è·å–ä¸€æ¬¡ï¼Œè·å–åˆ°äº†å°±okï¼Œå†æŒ‚è½½åˆ°futexçš„æ—¶å€™ä¸€å®šæ˜¯sleepingçŠ¶æ€
</span><span class=c1></span>		<span class=nx>v</span> <span class=p>=</span> <span class=nx>atomic</span><span class=p>.</span><span class=nf>Xchg</span><span class=p>(</span><span class=nf>key32</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>l</span><span class=p>.</span><span class=nx>key</span><span class=p>),</span> <span class=nx>mutex_sleeping</span><span class=p>)</span>
		<span class=k>if</span> <span class=nx>v</span> <span class=o>==</span> <span class=nx>mutex_unlocked</span> <span class=p>{</span>
			<span class=k>return</span>
		<span class=p>}</span>
        <span class=c1>// æ¥åˆ°è¿™å—ï¼Œè¯æ˜æˆ‘ä»¬çš„é”è·å–ä¸åˆ°äº†ï¼Œæˆ‘ä»¬è¦å»ç¡çœ äº†
</span><span class=c1></span>		<span class=nx>wait</span> <span class=p>=</span> <span class=nx>mutex_sleeping</span>
		<span class=nf>futexsleep</span><span class=p>(</span><span class=nf>key32</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>l</span><span class=p>.</span><span class=nx>key</span><span class=p>),</span> <span class=nx>mutex_sleeping</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span>
	<span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><h3 id=é‡Šæ”¾é”-1>é‡Šæ”¾é”</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-go data-lang=go><span class=kd>func</span> <span class=nf>unlock</span><span class=p>(</span><span class=nx>l</span> <span class=o>*</span><span class=nx>mutex</span><span class=p>)</span> <span class=p>{</span>
	<span class=nf>unlockWithRank</span><span class=p>(</span><span class=nx>l</span><span class=p>)</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=nf>unlock2</span><span class=p>(</span><span class=nx>l</span> <span class=o>*</span><span class=nx>mutex</span><span class=p>)</span> <span class=p>{</span>
    <span class=c1>// æŠŠé”è®¾ç½®æˆmutex_unlocked
</span><span class=c1></span>	<span class=nx>v</span> <span class=o>:=</span> <span class=nx>atomic</span><span class=p>.</span><span class=nf>Xchg</span><span class=p>(</span><span class=nf>key32</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>l</span><span class=p>.</span><span class=nx>key</span><span class=p>),</span> <span class=nx>mutex_unlocked</span><span class=p>)</span>
    <span class=c1>// åˆ¤æ–­åŸæ¥æ˜¯ä¸æ˜¯å°±æ˜¯è§£é”çŠ¶æ€
</span><span class=c1></span>	<span class=k>if</span> <span class=nx>v</span> <span class=o>==</span> <span class=nx>mutex_unlocked</span> <span class=p>{</span>
		<span class=nf>throw</span><span class=p>(</span><span class=s>&#34;unlock of unlocked lock&#34;</span><span class=p>)</span>
	<span class=p>}</span>
    <span class=c1>// å¦‚æœé”åœ¨ç¡çœ ä¸­ï¼Œæˆ‘ä»¬å°±å”¤é†’ä¸€ä¸ª
</span><span class=c1></span>	<span class=k>if</span> <span class=nx>v</span> <span class=o>==</span> <span class=nx>mutex_sleeping</span> <span class=p>{</span>
		<span class=nf>futexwakeup</span><span class=p>(</span><span class=nf>key32</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>l</span><span class=p>.</span><span class=nx>key</span><span class=p>),</span> <span class=mi>1</span><span class=p>)</span>
	<span class=p>}</span>

	<span class=nx>gp</span> <span class=o>:=</span> <span class=nf>getg</span><span class=p>()</span>
	<span class=nx>gp</span><span class=p>.</span><span class=nx>m</span><span class=p>.</span><span class=nx>locks</span><span class=o>--</span>
	<span class=k>if</span> <span class=nx>gp</span><span class=p>.</span><span class=nx>m</span><span class=p>.</span><span class=nx>locks</span> <span class=p>&lt;</span> <span class=mi>0</span> <span class=p>{</span>
		<span class=nf>throw</span><span class=p>(</span><span class=s>&#34;runtimeÂ·unlock: lock count&#34;</span><span class=p>)</span>
	<span class=p>}</span>
	<span class=k>if</span> <span class=nx>gp</span><span class=p>.</span><span class=nx>m</span><span class=p>.</span><span class=nx>locks</span> <span class=o>==</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=nx>gp</span><span class=p>.</span><span class=nx>preempt</span> <span class=p>{</span> <span class=c1>// restore the preemption request in case we&#39;ve cleared it in newstack
</span><span class=c1></span>		<span class=nx>gp</span><span class=p>.</span><span class=nx>stackguard0</span> <span class=p>=</span> <span class=nx>stackPreempt</span>
	<span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>æ›´æ–°äº 2022-09-04</span></div></div><div class=post-info-line><div class=post-info-md><span><a class=link-to-markdown href=/4.-runtime%E4%B9%8Bmutex%E7%BA%BF%E7%A8%8B%E9%94%81%E7%9A%84%E5%AE%9E%E7%8E%B0/index.md target=_blank>é˜…è¯»åŸå§‹æ–‡æ¡£</a></span></div><div class=post-info-share><span><a href=javascript:void(0); title="åˆ†äº«åˆ° Hacker News" data-sharer=hackernews data-url=https://xsc.scccc.cn/4.-runtime%E4%B9%8Bmutex%E7%BA%BF%E7%A8%8B%E9%94%81%E7%9A%84%E5%AE%9E%E7%8E%B0/ data-title="4. runtimeä¹‹mutexçº¿ç¨‹é”çš„å®ç°"><i class="fab fa-hacker-news fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="åˆ†äº«åˆ° Line" data-sharer=line data-url=https://xsc.scccc.cn/4.-runtime%E4%B9%8Bmutex%E7%BA%BF%E7%A8%8B%E9%94%81%E7%9A%84%E5%AE%9E%E7%8E%B0/ data-title="4. runtimeä¹‹mutexçº¿ç¨‹é”çš„å®ç°"><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@7.3.0/icons/line.svg aria-hidden=true></i></a><a href=javascript:void(0); title="åˆ†äº«åˆ° å¾®åš" data-sharer=weibo data-url=https://xsc.scccc.cn/4.-runtime%E4%B9%8Bmutex%E7%BA%BF%E7%A8%8B%E9%94%81%E7%9A%84%E5%AE%9E%E7%8E%B0/ data-title="4. runtimeä¹‹mutexçº¿ç¨‹é”çš„å®ç°"><i class="fab fa-weibo fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="åˆ†äº«åˆ° ç™¾åº¦" data-sharer=baidu data-url=https://xsc.scccc.cn/4.-runtime%E4%B9%8Bmutex%E7%BA%BF%E7%A8%8B%E9%94%81%E7%9A%84%E5%AE%9E%E7%8E%B0/ data-title="4. runtimeä¹‹mutexçº¿ç¨‹é”çš„å®ç°"><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@7.3.0/icons/baidu.svg aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/tags/runtime/>runtime</a>,&nbsp;<a href=/tags/go%E5%BA%95%E5%B1%82%E5%AE%9E%E7%8E%B0/>goåº•å±‚å®ç°</a></section><section><span><a href=javascript:void(0); onclick=window.history.back();>è¿”å›</a></span>&nbsp;|&nbsp;<span><a href=/>ä¸»é¡µ</a></span></section></div><div class=post-nav><a href=/3.-runtime%E4%B9%8Blockrank%E9%94%81%E6%8E%92%E5%90%8D%E6%9C%BA%E5%88%B6/ class=prev rel=prev title="3. runtimeä¹‹lockRanké”æ’åæœºåˆ¶"><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>3. runtimeä¹‹lockRanké”æ’åæœºåˆ¶</a>
<a href=/5.-runtime%E4%B9%8Bnote%E4%B8%80%E6%AC%A1%E6%80%A7%E9%80%9A%E7%9F%A5%E4%BA%8B%E4%BB%B6-copy/ class=next rel=next title="5. runtimeä¹‹noteä¸€æ¬¡æ€§é€šçŸ¥äº‹ä»¶">5. runtimeä¹‹noteä¸€æ¬¡æ€§é€šçŸ¥äº‹ä»¶<i class="fas fa-angle-right fa-fw" aria-hidden=true></i></a></div></div><div id=comments><div id=utterances class=comment></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://utteranc.es/>utterances</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2022 - 2024</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=https://xsc.scccc.cn target=_blank>Xsc</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span><span class=icp-splitter>&nbsp;|&nbsp;</span><br class=icp-br><span class=icp><a href=https://beian.miit.gov.cn>æ™‹ICPå¤‡20005176å·-1</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=å›åˆ°é¡¶éƒ¨><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i></a><a href=# id=view-comments class=fixed-button title=æŸ¥çœ‹è¯„è®º><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/css/lightgallery-bundle.min.css><script type=text/javascript src=https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lunr@2.3.9/lunr.min.js></script><script type=text/javascript src=/lib/lunr/lunr.stemmer.support.min.js></script><script type=text/javascript src=/lib/lunr/lunr.zh.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/twemoji@14.0.2/dist/twemoji.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/lightgallery.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/plugins/thumbnail/lg-thumbnail.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/plugins/zoom/lg-zoom.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/typeit@8.6.0/dist/index.umd.js></script><script type=text/javascript>window.config={"code":{"copyTitle":"å¤åˆ¶åˆ°å‰ªè´´æ¿","maxShownLines":50},"comment":{"utterances":{"darkTheme":"github-dark","issueTerm":"pathname","label":"actposts","lightTheme":"github-light","repo":"xue1213888/xue1213888"}},"data":{"id-1":"Xsc Study Notes","id-2":"Xsc Study Notes"},"lightgallery":true,"search":{"highlightTag":"em","lunrIndexURL":"/index.json","lunrLanguageCode":"zh","lunrSegmentitURL":"/lib/lunr/lunr.segmentit.js","maxResultLength":10,"noResultsFound":"æ²¡æœ‰æ‰¾åˆ°ç»“æœ","snippetLength":30,"type":"lunr"},"twemoji":true,"typeit":{"cursorChar":"|","cursorSpeed":1000,"data":{"id-1":["id-1"],"id-2":["id-2"]},"duration":-1,"speed":100}};</script><script type=text/javascript src=/js/theme.min.js></script></body></html>